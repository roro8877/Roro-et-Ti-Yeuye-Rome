<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jeu de piste Rome ‚Äì Carte interactive</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --brand:#2b6cb0; --ok:#2f855a; --warn:#b7791f; --err:#c53030;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    #app { display:flex; flex-direction:column; height:100%; }
    header {
      padding: 10px 14px; background: var(--brand); color: #fff; position: sticky; top: 0; z-index: 1000;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    header h1 { font-size: 16px; margin: 0; font-weight: 700; }
    header .btn { border:0; background:rgba(255,255,255,.15); color:#fff; padding:8px 10px; border-radius:10px; font-size:14px; }
    #map { flex: 1; }
    .panel { position: fixed; left: 10px; right: 10px; bottom: 10px; display:flex; gap:10px; z-index:1001; }
    .card { flex:1; background:#fff; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.15); padding:10px; }
    .status { font-size:12px; color:#333; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .status .dot { width:8px; height:8px; border-radius:999px; display:inline-block; margin-right:6px; }
    .status .ok { background:var(--ok); }
    .status .warn { background:var(--warn); }
    .status .err { background:var(--err); }
    .places { max-height: 28vh; overflow:auto; margin-top:6px; font-size:14px; }
    .place-row { display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; }
    .place-row + .place-row { margin-top:6px; }
    .place-row.locked { background:#f7fafc; }
    .place-row.unlocked { background:#f0fff4; }
    .place-row.done { background:#edf2f7; text-decoration: line-through; color:#4a5568; }
    .place-row .right { font-size:12px; color:#4a5568; }
    .fab { position: fixed; right: 16px; top: 60px; z-index: 1001; }
    .fab button { border:0; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.2); border-radius:999px; padding:10px 12px; }
    .leaflet-popup-content { margin: 10px; }
    .popup h3 { margin: 0 0 8px 0; font-size:16px; }
    .popup p { margin: 0 0 8px 0; }
    .popup input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #cbd5e0; margin-bottom: 8px; }
    .popup button { width: 100%; padding: 10px; border-radius: 10px; border: 0; background: var(--brand); color:#fff; font-weight:600; }
    .hint { font-size:12px; color:#4a5568; }
    .badge { display:inline-flex; align-items:center; gap:6px; background:#edf2f7; border-radius:999px; padding:4px 8px; font-size:12px; }
    .legend { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Jeu de piste Rome</h1>
      <div class="legend">
        <span class="badge">üîí verrouill√©</span>
        <span class="badge">üîì √† port√©e</span>
        <span class="badge">‚úÖ valid√©</span>
      </div>
      <button id="btnReset" class="btn" title="R√©initialiser la progression">R√©initialiser</button>
    </header>

    <div id="map"></div>

    <div class="fab">
      <button id="btnLocate" title="Me localiser">üìç</button>
    </div>

    <div class="panel">
      <div class="card">
        <div class="status" id="gpsStatus">
          <div><span class="dot err" id="gpsDot"></span><span id="gpsText">GPS inactif</span></div>
          <div><span id="accText">‚Äî</span></div>
        </div>
        <div class="places" id="placesList"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // =============================
    // 1) CONFIGURATION √Ä PERSONNALISER
    // =============================
    // CONSEIL: ajoute tes clins d'≈ìil perso dans 'question', 'hint' ou 'answer'.
    const PLACES = [
      {
        id: 'colisee',
        name: 'Colis√©e',
        lat: 41.8902,
        lng: 12.4922,
        radius: 20, // m√®tres
        question: "Au Colis√©e, notre 'gladiateur' du groupe avait quel surnom ?",
        answer: "le buffle", // insensible √† la casse + accents ignor√©s
        hint: "Surnom cri√© pendant le match de 2018‚Ä¶"
      },
      {
        id: 'trevi',
        name: 'Fontaine de Tr√©vi',
        lat: 41.9009,
        lng: 12.4833,
        radius: 20,
        question: "Quel v≈ìu absurde avons-nous fait ce soir-l√† ? (un mot)",
        answer: "licorne",
        hint: "Animal mythique + gelato pistache"
      },
      {
        id: 'pantheon',
        name: 'Panth√©on',
        lat: 41.8986,
        lng: 12.4769,
        radius: 20,
        question: "Comment s'appelle l'ouverture au sommet du d√¥me ?",
        answer: "oculus",
        hint: "Mot latin, 6 lettres"
      },
      {
        id: 'cetu',
        name: 'Cetu',
        lat: 45.73814894730028, 
        lng: 4.924226007905129,
        radius: 20, // m√®tres
        question: "Quelle affiche est pr√©sente sur ma porte",
        answer: "Sortir la t√™te du tunnel", // insensible √† la casse + accents ignor√©s
        hint: "Une expression"
      },
      {
        id: 'appart',
        name: 'Appart',
        lat: 45.750905494764886, 
        lng: 4.903803132674717,
        radius: 20, // m√®tres
        question: "Qui est en coloc avec nous",
        answer: "Cam et Clem", // insensible √† la casse + accents ignor√©s
        hint: "Famille"
      }
      // üëâ Ajoute d'autres lieux ici
    ];

    // Options g√©n√©rales
    const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const TILE_ATTRIB = '&copy; contributeurs <a href="https://www.openstreetmap.org/">OpenStreetMap</a>';
    const START_VIEW = [41.8986, 12.4769]; // Panth√©on, centre sympa
    const START_ZOOM = 15;
    const GEO_OPTIONS = { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 };

    // =============================
    // 2) UTILITAIRES
    // =============================
    const normalize = (s) => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase();
    const storageKey = (suffix) => `rome-game-${suffix}`;
    const save = (k, v) => localStorage.setItem(storageKey(k), JSON.stringify(v));
    const load = (k, def) => { try { return JSON.parse(localStorage.getItem(storageKey(k))) ?? def; } catch { return def; } };

    // =============================
    // 3) CARTE & COUCHES
    // =============================
    const map = L.map('map');
    L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(map);
    map.setView(START_VIEW, START_ZOOM);

    // Ic√¥nes
    const IconLocked = new L.DivIcon({ className: 'icon-locked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #718096;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîí</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconUnlocked = new L.DivIcon({ className: 'icon-unlocked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #38a169;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîì</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconDone = new L.DivIcon({ className: 'icon-done', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #2b6cb0;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">‚úÖ</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });

    // √âtat des lieux (progression)
    const progress = load('progress', {}); // { [id]: 'locked'|'unlocked'|'done' }

    // Calques
    const placesLayer = L.layerGroup().addTo(map);

    // Marqueur utilisateur + pr√©cision
    let userMarker = null, accuracyCircle = null;

    // =============================
    // 4) RENDU LISTE + MARQUEURS
    // =============================
    const placesList = document.getElementById('placesList');

    function renderList() {
      placesList.innerHTML = '';
      PLACES.forEach(p => {
        const state = progress[p.id] || 'locked';
        const row = document.createElement('div');
        row.className = `place-row ${state}`;
        row.innerHTML = `
          <div><strong>${p.name}</strong><div class="hint">rayon ${p.radius} m</div></div>
          <div class="right">${state === 'done' ? '‚úÖ' : state === 'unlocked' ? 'üîì' : 'üîí'}</div>
        `;
        row.onclick = () => {
          map.setView([p.lat, p.lng], 18, { animate: true });
        };
        placesList.appendChild(row);
      });
    }

    function placePopupContent(p) {
      const state = progress[p.id] || 'locked';
      if (state === 'locked') {
        return `<div class="popup"><h3>${p.name}</h3><p>üîí Tu es trop loin pour d√©verrouiller cette √©tape. Approche-toi √† moins de <strong>${p.radius} m</strong>.</p></div>`;
      }
      if (state === 'done') {
        return `<div class="popup"><h3>${p.name}</h3><p>‚úÖ D√©j√† valid√© !</p><p class="hint">Tu peux revenir pour le plaisir üòâ</p></div>`;
      }
      if (state === 'unlocked') {
        // √âtape √† port√©e mais pas encore commenc√©e
        return `
          <div class="popup">
            <h3>${p.name}</h3>
            <p>Tu es √† port√©e. Pr√™te ?</p>
            <button onclick="window.__startChallenge('${p.id}')">Commencer le d√©fi</button>
          </div>`;
      }
      // state === 'started' ‚Üí afficher la question (sans r√©√©crire le popup pendant le suivi GPS)
      return `
        <div class="popup">
          <h3>${p.name}</h3>
          <p>${p.question}</p>
          <input id="ans-${p.id}" type="text" placeholder="R√©ponse" autofocus />
          <button onclick="window.__checkAnswer('${p.id}')">Valider</button>
          <p class="hint">Indice : ${p.hint || '‚Äî'}</p>
        </div>`;
    }

    const markersById = {};
    const lastPopupState = {}; // m√©morise le dernier √©tat affich√© pour √©viter de recr√©er le contenu (et perdre le focus) = {};

    function addPlaceMarker(p) {
      const state = progress[p.id] || 'locked';
      const marker = L.marker([p.lat, p.lng], { icon: state==='done'?IconDone: (state==='unlocked'||state==='started')?IconUnlocked:IconLocked });
      marker.bindPopup(placePopupContent(p));
      marker.on('popupopen', () => { lastPopupState[p.id] = progress[p.id] || 'locked'; });
      marker.addTo(placesLayer);
      markersById[p.id] = marker;
    }

    function refreshMarker(p) {
      const marker = markersById[p.id];
      const state = progress[p.id] || 'locked';
      marker.setIcon(state==='done'?IconDone: (state==='unlocked'||state==='started')?IconUnlocked:IconLocked);
      marker.setPopupContent(placePopupContent(p));
    }

    // Initial render
    PLACES.forEach(addPlaceMarker);
    renderList();

    // Rendre accessible aux boutons popup
    window.__startChallenge = function(id) {
      const p = PLACES.find(x => x.id === id);
      if (!p) return;
      progress[id] = 'started';
      save('progress', progress);
      refreshMarker(p);
      markersById[id].openPopup();
      lastPopupState[id] = 'started';
    }

    window.__checkAnswer = function(id) {
      const p = PLACES.find(x => x.id === id);
      const input = document.getElementById(`ans-${id}`);
      if (!p) return;
      if (!input) { return; }
      const ok = normalize(input.value) === normalize(p.answer);
      const gpsText = document.getElementById('gpsText');
      if (ok) {
        progress[id] = 'done';
        save('progress', progress);
        refreshMarker(p);
        renderList();
        gpsText.textContent = `Bravo ! √âtape ¬´ ${p.name} ¬ª valid√©e.`;
        lastPopupState[id] = 'done';
      } else {
        gpsText.textContent = 'Mauvaise r√©ponse, essaie encore.';
        // garder le focus pour retaper
        input.focus();
        input.select && input.select();
      }
    }

    // =============================
    // 5) G√âOLOCALISATION / GEOFENCING
    // =============================
    const gpsDot = document.getElementById('gpsDot');
    const gpsText = document.getElementById('gpsText');
    const accText = document.getElementById('accText');

    let watchId = null;

    function setStatus(kind, text, acc) {
      gpsDot.className = 'dot ' + (kind || 'err');
      gpsText.textContent = text || '';
      accText.textContent = acc ? `¬± ${Math.round(acc)} m` : '‚Äî';
    }

    function ensureLocate() {
      if (!('geolocation' in navigator)) {
        setStatus('err', 'G√©olocalisation non support√©e');
        return;
      }
      if (watchId !== null) return; // d√©j√† en cours
      setStatus('warn', 'Demande de GPS‚Ä¶');
      watchId = navigator.geolocation.watchPosition(onPos, onGeoError, GEO_OPTIONS);
    }

    function onGeoError(err) {
      setStatus('err', err.message || 'Erreur de g√©olocalisation');
    }

    function onPos(pos) {
      const { latitude, longitude, accuracy } = pos.coords;
      const here = [latitude, longitude];

      // Afficher/mettre √† jour marqueur utilisateur
      if (!userMarker) {
        userMarker = L.marker(here, { title: 'Vous' }).addTo(map);
      } else {
        userMarker.setLatLng(here);
      }
      if (!accuracyCircle) {
        accuracyCircle = L.circle(here, { radius: accuracy, weight: 1, fillOpacity: 0.1 });
        accuracyCircle.addTo(map);
      } else {
        accuracyCircle.setLatLng(here).setRadius(accuracy);
      }

      setStatus('ok', 'GPS actif', accuracy);

      // V√©rifier distance √† chaque lieu
      PLACES.forEach(p => {
        const prevState = progress[p.id] || 'locked';
        const d = map.distance(here, [p.lat, p.lng]);
        const radius = p.radius || 20;

        // D√©verrouillage si √† port√©e et pas d√©j√† valid√©
        if (d <= radius && prevState === 'locked') {
          progress[p.id] = 'unlocked';
          save('progress', progress);
          refreshMarker(p);
          renderList();
          markersById[p.id].openPopup();
          lastPopupState[p.id] = 'unlocked';
        }

        // Mise √† jour popup SANS casser le focus :
        const currState = progress[p.id] || 'locked';
        const m = markersById[p.id];
        if (m.isPopupOpen()) {
          if (currState === 'locked') {
            // Pour l'√©tat verrouill√© uniquement, on met √† jour la distance dynamiquement
            m.setPopupContent(`<div class=\"popup\"><h3>${p.name}</h3><p>üîí Tu es √† <strong>${Math.round(d)} m</strong>. Approche √† moins de <strong>${radius} m</strong> pour d√©verrouiller.</p></div>`);
            lastPopupState[p.id] = 'locked';
          } else if (lastPopupState[p.id] !== currState) {
            // Ne rafra√Æchir le contenu que si l'√©tat a chang√© (√©vite de perdre le focus clavier)
            m.setPopupContent(placePopupContent(p));
            lastPopupState[p.id] = currState;
          }
        }
      });
    }

    // =============================
    // 6) BOUTONS UI
    // =============================
    document.getElementById('btnLocate').addEventListener('click', () => {
      ensureLocate();
      if (userMarker) map.setView(userMarker.getLatLng(), 17, { animate: true });
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (!confirm('R√©initialiser toute la progression ?')) return;
      localStorage.removeItem(storageKey('progress'));
      Object.keys(progress).forEach(k => delete progress[k]);
      PLACES.forEach(p => refreshMarker(p));
      renderList();
      setStatus('warn', 'Progression r√©initialis√©e');
    });

    // D√©marrage: restaurer progression
    window.addEventListener('load', () => {
      // resynchroniser ic√¥nes selon progression
      PLACES.forEach(p => refreshMarker(p));
      renderList();
    });

    // Astuce iOS: d√©clencher geoloc suite √† une interaction utilisateur
    // On invite l'utilisateur √† appuyer sur üìç
  </script>
</body>
</html>
