<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jeu de piste Rome ‚Äì Carte interactive</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{--brand:#2b6cb0;--ok:#2f855a;--warn:#b7791f;--err:#c53030;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';}
    /* Mise en page avec menu */
    /* Layout simplifi√© : une seule colonne, menu lat√©ral d√©sactiv√© */
    #app{display:grid;grid-template-columns:1fr;grid-template-rows:auto 1fr;min-height:100vh;}
    /* Ancien layout (d√©sactiv√©) */
    #app.with-drawer{display:grid;grid-template-columns:1fr;grid-template-rows:auto 1fr;}
    /* On force le drawer √† ne plus s'afficher */
    #drawer{display:none !important;}
    #drawer{grid-row:1/span 2;grid-column:1;background:#0f2747;color:#fff;padding:12px;display:block;}
    #drawer .drawer-header{grid-column:1;padding:10px 14px;background:var(--brand);color:#fff;position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .btn{border:0;background:rgba(255,255,255,.15);color:#fff;padding:8px 10px;border-radius:10px;font-size:14px}
    .top-nav{display:flex;gap:8px;flex-wrap:wrap}
    .top-nav.collapsed{display:none}
    .top-nav .nav-item{background:rgba(255,255,255,.15);color:#fff;border:0;border-radius:10px;padding:6px 10px;cursor:pointer}
    .top-nav .nav-item.active{background:rgba(255,255,255,.28)}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#edf2f7;border-radius:999px;padding:4px 8px;font-size:12px;color:#1a202c}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #drawer .nav-item{width:100%;text-align:left;background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;cursor:pointer}
    #drawer .nav-item.active,#drawer .nav-item:hover{background:rgba(255,255,255,.12)}
    #drawer .nav-item[disabled]{opacity:.5; pointer-events:none; cursor:not-allowed;}
    header{grid-column:1;padding:10px 14px;background:var(--brand);color:#fff;position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .btn{border:0;background:rgba(255,255,255,.15);color:#fff;padding:8px 10px;border-radius:10px;font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#edf2f7;border-radius:999px;padding:4px 8px;font-size:12px;color:#1a202c}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* √âcrans */
    .screen{grid-column:1;display:none;position:relative}
    .screen.visible{display:block}
    /* Carte + panneaux */
    #map{height:calc(100vh - 70px)}
    #mapP3{height:60vh;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-top:10px}
    .panel{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:10px;z-index:1001}
    .card{flex:1;background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:10px}
    .status{font-size:12px;color:#333;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .status .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .status .ok{background:var(--ok)} .status .warn{background:var(--warn)} .status .err{background:var(--err)}
    .places{max-height:28vh;overflow:auto;margin-top:6px;font-size:14px}
    .place-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px}
    .place-row + .place-row{margin-top:6px}
    .place-row.locked{background:#f7fafc}
    .place-row.unlocked,.place-row.started{background:#f0fff4}
    .place-row.done{background:#edf2f7;text-decoration:line-through;color:#4a5568}
    .place-row .right{font-size:12px;color:#4a5568}
    .fab{position:fixed;right:16px;top:60px;z-index:1001}
    .fab button{border:0;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.2);border-radius:999px;padding:10px 12px}
    .leaflet-popup-content{margin:10px}
    .popup h3{margin:0 0 8px 0;font-size:16px}
    .popup p{margin:0 0 8px 0}
    .popup input{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e0;margin-bottom:8px}
    .popup button{width:100%;padding:10px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:600}
    .hint{font-size:12px;color:#4a5568}
    /* Progress bars */
    .progress{margin:8px 0 10px}
    .progress-row{font-size:14px;margin-bottom:6px}
    .bar{background:#e2e8f0;border-radius:999px;height:10px;overflow:hidden}
    .bar span{display:block;height:100%;background:var(--brand)}
    details.key[disabled] summary { color:#718096; }
    details.key[disabled] { pointer-events: none; opacity: 0.7; }
    details.key[disabled] .key-content { display: none; }
    /* Partie 2 : rooms/works */
    .rooms{padding:12px;display:grid;gap:12px}
    .room{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:10px}
    .room h3{margin-top:0}
    .work{display:flex;gap:8px;align-items:center;padding:6px 0}
    .work .state{width:22px;text-align:center}
	.work input[type=text]{flex:1;min-width:0;width:100%;max-width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #cbd5e0}
    .work button{padding:8px 10px;border-radius:8px;border:0;background:var(--brand);color:#fff}
    .btn.small{padding:6px 10px;font-size:12px}
	.panel.collapsed {
		transform: translateY(110%);
		opacity: 0;
		pointer-events: none;
		transition: transform 0.3s ease, opacity 0.3s ease;
	}
	@media (max-width:600px){
   .work input[type=text]{font-size:14px;padding:6px;width:100%;}
   .work button{flex-shrink:0;}
	}
  </style>
</head>
<body>
  <div id="app" class="with-drawer">
    <aside id="drawer">
      <div class="drawer-header">Menu</div>
      <nav>
        <button class="nav-item active" data-target="part1">üó∫Ô∏è Partie 1 ‚Äî Rome</button>
        <button class="nav-item" data-target="part2">üñºÔ∏è Partie 2 ‚Äî Vatican</button>
        <button class="nav-item" data-target="part3">üå≥ Partie 3 ‚Äî Finale</button>
      </nav>
    </aside>

    <header>
      <button id="btnDrawer" class="btn" title="Replier/afficher le menu du haut">‚ò∞</button>
      <nav id="topNav" class="top-nav">
        <button class="nav-item active" data-target="part1">üó∫Ô∏è Partie 1</button>
        <button class="nav-item" data-target="part2">üñºÔ∏è Partie 2</button>
        <button class="nav-item" data-target="part3">üå≥ Partie 3</button>
      </nav>
      <button id="btnReset" class="btn" title="R√©initialiser la progression">R√©initialiser</button>
    </header>

    <!-- ===== PARTIE 1 : CARTE & D√âFIS ROME ===== -->
    <section id="part1" class="screen visible">
      <div id="map"></div>

      <div class="fab">
		<button id="btnLocate" title="Me localiser">üìç</button>
		</div>
      <div class="panel-toggle" style="position:fixed;right:16px;bottom:16px;z-index:2000;">
		<button id="btnPanelToggle" title="Replier / afficher le panneau bas" style="border:0;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.2);border-radius:999px;padding:10px 12px;font-size:18px">‚¨áÔ∏è</button>
	  </div>

      <div class="panel">
        <div class="card">
          <div class="status" id="gpsStatus">
            <div><span class="dot err" id="gpsDot"></span><span id="gpsText">GPS inactif</span></div>
            <div><span id="accText">‚Äî</span></div>
          </div>
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 1</strong> ‚Äî <span id="p1Pct">0%</span></div>
            <div class="bar"><span id="p1Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p1Gages">
            <summary>üé≤ Gages </summary>
            <ul>
              <li><label><input type="radio" name="p1gage" value="0-20"> 0‚Äì20% : Ils sont sympas les maillots du Milan non ? </label></li>
              <li><label><input type="radio" name="p1gage" value="20-40"> 20‚Äì40% : J'aimerais beaucoup manger une glace tous les jours </label></li>
              <li><label><input type="radio" name="p1gage" value="40-60"> 40‚Äì60% : Un restau et on en parle plus </label></li>
              <li><label><input type="radio" name="p1gage" value="60-80"> 60‚Äì80% : Un petit selfie statue et une pose gladiateur ? </label></li>
              <li><label><input type="radio" name="p1gage" value="80-99"> 80‚Äì99% : Une petite pipe et c'est r√©gl√© </label></li>
            </ul>
            <button id="p1GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 1 √† 100%</button>
          </details>
          <details id="p1Key" class="key" disabled>
            <summary>üìÅ Cl√© 1</summary>
            <div class="key-content"><strong>Doria</strong></div>
          </details>
          <div class="places" id="placesList"></div>
        </div>
      </div>
    </section>

    <!-- ===== PARTIE 2 : MUS√âES DU VATICAN ===== -->
    <section id="part2" class="screen">
      <div class="vatican">
        <div class="card">
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 2</strong> ‚Äî <span id="p2Pct">0%</span></div>
            <div class="bar"><span id="p2Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p2Gages">
            <summary>üé≤ Gages </summary>
            <ul>
              <li><label><input type="radio" name="p2gage" value="0-20"> 0‚Äì20% : Tu dois absolument aller voir le pape, il suffit de le demander aux gardes et √ßa suffira je pense</label></li>
              <li><label><input type="radio" name="p2gage" value="20-40"> 20‚Äì40% : J'aimerais bien te voir dans un costume de personnalit√© religieuse </label></li>
              <li><label><input type="radio" name="p2gage" value="40-60"> 40‚Äì60% : J'ai le droit de te l√©chouiller le bout du nez autant que je veux !</label></li>
              <li><label><input type="radio" name="p2gage" value="60-80"> 60‚Äì80% : Ma mamie aimerait beaucoup que tu lui offre un super cadeau du Vatican </label></li>
              <li><label><input type="radio" name="p2gage" value="80-99"> 80‚Äì99% : Petit clich√© en imitant une oeuvre ? </label></li>
            </ul>
            <button id="p2GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 2 √† 100%</button>
          </details>
          <details id="p2Key" class="key" disabled>
            <summary>üìÅ Cl√© 2 </summary>
            <div class="key-content"><strong>Pamphilj</strong></div>
          </details>
        </div>

        <div class="rooms" id="rooms"></div>
      </div>
    </section>

    <!-- ===== PARTIE 3 : FINALE ===== -->
    <section id="part3" class="screen">
      <div class="card">
        <h3>Finale </h3>
        <div id="p3Status" class="hint">üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.</div>
        <div class="progress">
          <div class="progress-row"><strong>Avanc√©e</strong> ‚Äî <span id="p3Pct">0%</span></div>
          <div class="bar"><span id="p3Bar" style="width:0%"></span></div>
        </div>
        <div id="p3Action" style="display:none">
         
        </div>
        <!-- Dossier Victoire (d√©bloqu√© uniquement quand le Point A est atteint) -->
        <details id="p3Victory" class="key" disabled>
          <summary>üìÅ Victoire</summary>
          <div class="key-content"><a id="victoryLink" href="#" target="_blank" class="btn">üéâ Voir la vid√©o</a></div>
        </details>
        <!-- Carte de la Partie 3 (affich√©e seulement si ‚â§ 1500 m de B et cl√©s OK) -->
        <div id="p3MapWrap" style="display:none">
          <div id="mapP3"></div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ========= 1) CONFIG =========

  const PLACES = [
	 // ‚Äî Florence (exemples) ‚Äî
  { id:'f_duomo', name:'Piazza del Duomo', lat:43.773449, lng:11.256236, radius:20,
    question:"Quelle fleur appara√Æt sur le bas-relief central de la fa√ßade du Duomo ?", answer:"lys", hint:"symbole des M√©dicis" },
  { id:'f_ponte_vecchio', name:'Ponte Vecchio', lat:43.768009, lng:11.253165, radius:20,
    question:"Quel m√©tal orne les petites plaques des boutiques du pont ?", answer:"or", hint:"" },
  { id:'f_uffizi', name:'Galerie des Offices', lat:43.767788, lng:11.255256, radius:20,
    question:"Quel peintre a sa ¬´ Naissance de V√©nus ¬ª dans cette galerie ?", answer:"botticelli", hint:"premier nom : Sandro" },
  { id:'f_santacroce', name:'Basilique Santa Croce', lat:43.76883435791265,  lng:11.26162196723657, radius:20,
    question:"Quels grands noms sont enterr√©s dans cette √©glise ?", answer:"michel angelo, Machiavel, Galil√©e", hint:"sculpteur, politique, scientifique" },
  { id:'f_signoria', name:'Piazza della Signoria', lat:43.76974701191463,  lng:11.255755261405659, radius:20,
    question:"A qui est d√©di√© la fontaine ?", answer:"Neptune", hint:"Petite planette" },
 { id:'f_signoria', name:'Palazzo Vecchio', lat:43.769351884697215,  lng:11.255953744866352, radius:20,
    question:"Quelle statue de h√©ros biblique se tient devant le Palazzo Vecchio ici ?", answer:"david", hint:"statue de Michel-Ange (r√©plique)" },
  { id:'f_piazzamelanogelo', name:'Piazzale Michelangelo', lat:41.901094445961775,  lng:12.483226560794684, radius:20,
    question:"Quel monument domine la vue sur Florence depuis cette terrasse ?", answer:"le duomo", hint:"coupole imposante" },
	
	{ id:'palais_medicic', name:'Palais M√©dici Riccardi', lat: 43.77514139265466, lng :11.255898279288544 , radius:20,
    question:"De quelle siecle date ce palais ?", answer:"XV", hint:"En chiffre Romains" },
	
	{ id:'San lorenzo', name:'Basilique San Lorenzo', lat: 43.77528775990168, lng : 11.253465248674532 , radius:20,
    question:"A quelle chapelle est accol√©e cette basilique ?", answer:"Chapelle des Medicis", hint:"Empoisonneuse" },

	{ id:'Repubblica', name:'Piazza della Repubblica', lat: 43.771585499935114,  lng : 11.253940584384267, radius:20,
    question:"Comment s'appelle la colonne ornant cette place ? ", answer:"Colonne de l'Abondance", hint:"" },

	{ id:'Santa Maria', name:'Basilique Santa Maria Novella', lat: 43.77414579004759,   lng : 11.249402958897395, radius:20,
    question:" De quel ordre mendiant important cette basilique √©tait le point de r√©f√©rence ? ", answer:"Dominicains", hint:"..... nique nique ..." },

	{ id:'Palais PItti', name:'Palazzo Piti', lat: 43.76536923796827, lng :  11.249879167388647, radius:20,
    question:"Quel √©tait le m√©tier de Luca Pitti ", answer:"Banquier", hint:"Macron" },
	
	
		{ id:'Santo spirito', name:'Basilique Santo Spirito ', lat: 	43.7669910356199,  lng : 11.248001907286234, radius:20,
    question:"De qui est le crucifix en bois se trouvant dans la  sacristie ? ", answer:"Michel Ange", hint:"Toujours le m√™me" },
	
		{ id:'Academie', name:'Gallerie de l academie ', lat: 43.776826269497626,  lng :  11.25857814320013, radius:20,
    question:"Quelle sculpture est pr√©sente ici ?", answer:"David", hint:"" },
	
		{ id:'Boboli', name:'Jardin de Boboli ', lat: 43.762711926229315,   lng :   11.248512584904905, radius:500,
    question:"Sur quel animal est assis le gros monsieur ?", answer:"Tortue", hint:"" },



  // ‚Äî Rome (quelques exemples) ‚Äî
	{ id:'r_circo_massimo', name:'Circus Maximus', lat:41.8852, lng:12.4856, radius:50, question:"Quelle film fait r√©f√©rence √† ce cirque ?", answer:"Gladiator", hint:"Requin" },
	{ id:'r_pantheon', name:'Panth√©on', lat:41.8986, lng:12.4769, radius:200, question:"Comment s‚Äôappelle l‚Äôouverture circulaire au sommet de la coupole ?", answer:"oculus", hint:"Mot latin" },
	{ id:'r_piazza_navona', name:'Piazza Navona', lat:41.8992, lng:12.4731, radius:50, question:"Devine l'ambassade pr√©sente sur cette place seulement grace au drapeau", answer:"Br√©sil", hint:"" },
	{ id:'r_fontana_trevi', name:'Fontaine de Tr√©vi', lat:41.9009, lng:12.4833, radius:50, question:"Combien de pi√®ces lancer pour assurer un retour √† Rome ?", answer:"1", hint:"La tradition" },
	{ id:'r_scala_spagna', name:'Escalier de la Trinit√©-des-Monts', lat:41.9059, lng:12.4823, radius:50, question:"Combien il y a t-il de marche ?", answer:"174", hint:"Fini par 4 et racine carr√©e de 30276" },
	{ id:'r_trinita_monti', name:'Trinit√† dei Monti', lat:41.9066, lng:12.4829, radius:50, question:"En 1494 qui est √† l'origine de cette √©glise ? ", answer:"Charles VIII", hint:"Fils de Louis XI" },
	{ id:'r_piazza_venezia', name:'Piazza Venezia', lat:41.8947, lng:12.4824, radius:100, question:"Quel surnom donne-t-on au monument √† Victor-Emmanuel II ?", answer:"La machine √† √©crire", hint:"Un hobbie de Mercredi" },
	{ id:'r_vittoriano', name:'Vittoriano (Autel de la Patrie)', lat:41.8949, lng:12.4823, radius:100, question:"Quel soldat y est honor√© ?", answer:"soldat inconnu", hint:"Arc de Triomphe" },
	{ id:'r_campidoglio', name:'Piazza del Campidoglio', lat:41.8931, lng:12.4825, radius:50, question:"Quel artiste a pris en charge la r√©novation √† l'occasion de la visite √† Rome de l'empereur Charles Quint", answer:"michel-ange", hint:"Renaissance" },
	{ id:'r_bocca_verita', name:'Bocca della Verit√†', lat:41.8881, lng:12.4791, radius:50, question:"Dans quoi faut-il mettre la main selon la l√©gende ?", answer:"la bouche", hint:"Disque de marbre" },
	{ id:'r_isola_tiberina', name:'Isola Tiberina', lat:41.8907, lng:12.4783, radius:50, question:"Quel fleuve entoure l‚Äô√Æle ?", answer:"tibre", hint:"Fleuve de Rome" },
	{ id:'r_castel_santangelo', name:'Castel Sant‚ÄôAngelo', lat:41.9031, lng:12.4663, radius:200, question:"Quel empereur demande √† l'architecte Demetriano de construire un mausol√©e fun√©raire pour lui et sa famille", answer:"Hadrien", hint:"Un H en trop" },
	{ id:'r_ponte_santangelo', name:'Ponte Sant‚ÄôAngelo', lat:41.9022, lng:12.4669, radius:50, question:"Combien d‚Äôanges bordent le pont (de chaque c√¥t√© confondus) ?", answer:"10", hint:"Deux chiffres" },
	{ id:'r_piazza_san_pietro', name:'Place Saint-Pierre', lat:41.9022, lng:12.4564, radius:50, question:"Qui a √©t√© crucifi√© la t√™te en bas dans ces lieux", answer:"Saint Pierre", hint:"Plut√¥t √©vident" },
	{ id:'r_gianicolo', name:'Belv√©d√®re du Janicule', lat:41.891547836087575, lng:12.461059971688579, radius:40, question:"√Ä midi, qu‚Äôentend-on chaque jour depuis 1904 ?", answer:"un coup de canon", hint:"Tradition" },
	{ id:'r_teatro_marcello', name:'Th√©√¢tre de Marcellus', lat:41.8922, lng:12.4797, radius:100, question:"Vrai ou Faux ? Ce th√©atre est plus vieux que le Colis√©e ?", answer:"Vrai", hint:"" },
	{ id:'r_largo_argentina', name:'Largo di Torre Argentina', lat:41.8963, lng:12.4768, radius:50, question:"2 question : Que trouve-t-on aujourd‚Äôhui parmi les ruines ? Et qui est mort proche de ce lieu ? ", answer:"Des chats et Cesar", hint:"" },
	{ id:'r_mausoleo_augusto', name:'Mausol√©e', lat:41.9069, lng:12.4762, radius:50, question:"Quel empereur y est enterr√© ?", answer:"auguste", hint:"Le premier empereur" },
	{ id:'r_piazza_del_popolo', name:'Piazza del Popolo', lat:41.9109, lng:12.4768, radius:50, question:"Qui a mang√© la plus grosse glace de sa vie sur ce monument ?", answer:"Ti b√©b√© damour", hint:"" },
	{ id:'santa_maria_popolo', name:'√âglise Santa - Maria - del - Popolo ', lat:	41.91145341609236, lng:12.47658285508913, radius:50, question:"D'apr√®s la l√©gende, quel empereur a fond√© cette chapelle ? ", answer:"N√©ron", hint:"Empereur diabolique" },
	{ id:'capella_chigi', name:'Chapelle Chigi', lat:	41.91165395904638,  lng:12.476542179086927, radius:50, question:"Quel est la forme de la stelle ? ", answer:"Pyramidale", hint:"" },	
	{ id:'r_villa_borghese', name:'Parc de la Villa Borghese', lat:41.91331602597238,  lng:12.48765299224608, radius:100, question:"Quels animaux sont sur les armoiries de la famille ? ", answer:"aigle et dragon", hint:"Air et Feu" },
	{ id:'r_piazza_barberini', name:'Fontana del Triton', lat:41.90373793639694,  lng:12.488537723005166, radius:50, question:"Quel Dieu y est repr√©sent√© ? ", answer:"Dieu de la mer", hint:"" },
	{ id:'r_fontana_ape', name:'piazza Barberini', lat:41.904283667736514,  lng:12.488773854001808, radius:50, question:"Quel insecte figure sur le blason des Barberini ?", answer:"abeilles", hint:"Fontaine" },
	{ id:'r_quirinale', name:'Palais du Quirinal', lat:41.899821739821824,  lng:12.486410584461886, radius:50, question:"Qui y r√©side aujourd‚Äôhui (fonction) ?", answer:"pr√©sident de la r√©publique", hint:"" },
	{ id:'r_quattro_fontane', name:'Croisement des Fontane', lat:41.901983898832285, lng:12.4907272214971, radius:50, question:"Combien de fontaines √† ce carrefour ?", answer:"4", hint:"Le nom le dit" },
	{ id:'r_s_maria_vittoria', name:'Santa Maria della Vittoria', lat:41.90454264687852,  lng:12.494221783607648, radius:50, question:"Qui est l'auteur de la statue L'Extase de sainte Th√©r√®se ?", answer:"Le Bernin", hint:"Italien" },
	{ id:'r_colonna', name:'Piazza Colonna', lat:41.900848135488076,  lng:12.48000286543667, radius:50, question:"√Ä quel empereur est d√©di√©e la colonne ?", answer:"marc aur√®le", hint:"Bas-reliefs en spirale" },
	{ id:'r_montecitorio', name:'Piazza Montecitorio', lat:41.9006852090028,   lng:12.478676044812083, radius:50, question:"De quel temple √©gyptien provient cet obelisque ?", answer:"Temple de R√™", hint:" Divinit√© Note de musique" },
	{ id:'r_piazza_rotonda', name:'Piazza della Rotonda', lat:41.89928996363158, lng: 12.476734722852466, radius:50, question:"Quel √©difice monumental borde la place ?", answer:"Le panth√©on", hint:"Grand oculus" },
	{ id:'r_campo_fiori', name:'Campo de‚Äô Fiori', lat:41.8956, lng:12.4722, radius:50, question:"Qu'est-il pr√©sent habituellement sur cette place ?", answer:"Un march√©", hint:"Activit√© pr√©f√©r√©e de Ti Yeuye" },
	{ id:'r_santagnese', name:'Sant‚Äô***** in Agone', lat:41.898823703950505, lng:12.472888004705814,  radius:50, question:"Quel crane se trouve dans dans cette l‚Äô√©glise ?", answer:"Sainte Agnes", hint:"" },
	{ id:'r_minerva', name:'Santa Maria sopra Minerva', lat:41.89798443475502,  lng:12.477518875685979, radius:50, question:"Quel animal porte l‚Äôob√©lisque sur le parvis ?", answer:" un √©l√©phant", hint:"Statue du Bernin" },
	{ id:'r_sant_ignazio', name:'Sant‚ÄôIgnazio di Loyola', lat:41.89924564809118, lng:12.479713120613413, radius:50, question:"Quel effet optique au plafond simule une coupole ?", answer:"trompe-l'≈ìil", hint:"Illusion peinte" },
	{ id:'r_piazza_pietra', name:'Piazza di Pietra ', lat:41.900036062323764,  lng:12.47939527594256, radius:50, question:"A qui est d√©di√© ce temple ?", answer:"Hadrien", hint:"" },
	{ id:'r_giardino_aranci', name:'Giardino degli Aranci', lat:41.88510537605192, lng: 12.480419102096809, radius:50, question:"Quel parfum donne son nom au jardin ?", answer:"orangers", hint:"Agrumes" },
	{ id:'r_buco_serratura', name:'Trou de la Serrure', lat:41.88296515060144,  lng:12.478510745810217, radius:50, question:"√Ä travers le trou, quel d√¥me c√©l√®bre aper√ßoit-on ?", answer:"Dome de saint-pierre", hint:"Vue parfaite" },
	{ id:'r_san_luigi_francesi', name:'San Luigi dei Francesi', lat:41.89960236873012, lng:12.474885605959491 , radius:50, question:"Quel peintre y a trois toiles de Saint Matthieu ?", answer:"caravage", hint:"Clair-obscur" },
	{ id:'r_sant_agostino', name:'Sant‚ÄôAgostino', lat:41.90070934491156,  lng:12.474255380037807, radius:50, question:"Quel peintre y a une ¬´ Madone des P√®lerins ¬ª ?", answer:"caravage", hint:"Pieds sales" },
	{ id:'r_maria_pace', name:'Santa Maria della Pace', lat:41.89967506795449,  lng:12.471480560377081, radius:50, question:"Quel architecte a con√ßu le petit clo√Ætre ?", answer:"bramante", hint:"Renaissance" },
	{ id:'r_villa_medici', name:'Villa M√©dicis', lat:41.90826148706542,  lng:12.48253697257301, radius:50, question:"Quel pays y a son acad√©mie d‚Äôart ?", answer:"france", hint:"" },
	{ id:'r_santa_maria_maggiore', name:'Basilique Sainte-Marie-Majeure', lat:41.89798438746671,  lng:12.497863021541624, radius:50, question:"Quel m√©tal pr√©cieux recouvre le plafond ?", answer:"or", hint:"Don d‚ÄôEspagne" },
	{ id:'r_aracoeli', name:'Santa Maria in Aracoeli', lat:41.89348664109424,  lng:12.483541315378254, radius:50, question:"Quel est la particularit√© du plafond ? ", answer:"plafond √† caisson", hint:"T'as le droit √† internet, c'est dur" },
	{ id:'r_santandrea_valle', name:'Sant‚ÄôAndrea della Valle', lat:41.896465875058354,lng: 12.474363499999999 , radius:50, question:"Quelle est la forme de la croix peinte derriere l'hotel ?", answer:"une croix", hint:"" },
	{ id:'r_fontana_tartarughe', name:'Fontana delle Tartarughe', lat:41.89381409771133,  lng:12.477569530345708, radius:50, question:"Quel animal orne la fontaine ?", answer:"des tortues", hint:"Bronze" },
	{ id:'r_piazza_colonna_poste', name:'Piazza Colonna ‚Äì Palais des Postes', lat:41.900825245544695,  lng:12.479885942322245, radius:50, question:"Quel empereur est pr√©sent en haut de la colonne antique de la place ?", answer:"marc aur√®le", hint:"Colonne triomphale" },
	{ id:'r_termine', name:'Gare Termini ‚Äì Fa√ßade', lat:41.9010, lng:12.5014, radius:50, question:"Quel moyen de transport principal ici ?", answer:"train", hint:"Gare" },
	{ id:'r_cavour', name:'Piazza Cavour', lat:41.90498373133071,  lng:12.469969054685118, radius:50, question:"Quel pouvoir s‚Äôexerce dans ce palais ?", answer:"justice", hint:"Cour de cassation" },
	{ id:'r_forum_trajan', name:'Forum de XXXXX', lat:41.8958, lng:12.4846, radius:50, question:"Quelle forum trouve t-on ici ?", answer:"Forum Trajan", hint:"Empereur" },
	{ id:'r_forum_augustus', name:'Forum d‚ÄôXXXXX', lat:41.89424733763139,  lng:12.486918728650371, radius:50, question:"Quel empereur honore ce forum ?", answer:"Auguste", hint:"Premier empereur" },
	{ id:'r_domus_aurea', name:'Domus Aurea', lat:41.891670901279355,  lng:12.49609576919294, radius:50, question:"Quel empereur fit b√¢tir ce palais ?", answer:"n√©ron", hint:"Apr√®s l‚Äôincendie" }
    ];

    const ROOMS = [
  { id:'salle1', name:'Mus√©e Gr√©gorien √©gyptien ', works:[
    { id:'oeuvre1', title:"Naophore du Vatican", question:"Quel est le premier symbole du message sous Osiris ?", answer:"Un pigeon", hint:"Oiseau" },
    { id:'oeuvre2', title:"Statue du dieu Anubis", question:"A quel animal correspond la t√™te d‚Äôanubis ", answer:"Un chacal", hint:"f√©lin" }
  ]},
  { id:'salle11', name:'Galerie des Tapisseries', works:[
    { id:'oeuvre21', title:"Tapisseries", question:"Qui est le tapissier du pape ?", answer:"Pieter van Aelst", hint:"Belge un fois" },
	{ id:'oeuvre8', title:"Tapisserie de la C√®ne", question:"Combien d‚Äôap√¥tres entourent J√©sus ?", answer:"12", hint:"Classique" }
  ]},
  { id:'salle12', name:'Appartement Borgia', works:[
    { id:'oeuvre23', title:"Pinturicchio ‚Äì Les Arts lib√©raux", question:"Combien de figures f√©minines sont repr√©sent√©es ?", answer:"7", hint:"Comme les arts" },
    { id:'oeuvre24', title:"Pinturicchio ‚Äì La R√©surrection", question:"Combien de soldat garde inutilement le tombeau ?", answer:"2", hint:"" }
  ]},
  { id:'salle1', name:'Chapelle Sixtine', works:[
    { id:'oeuvre1', title:"Michel-Ange ‚Äì Cr√©ation d‚ÄôAdam", question:"Michel-Ange a r√©alis√©, au sein d‚Äôune puissante structure, neuf histoires centrales repr√©sentant des √©pisodes de la ?", answer:"Genese", hint:"Le d√©but" },
    { id:'oeuvre2', title:"Michel-Ange ‚Äì Jugement dernier", question:"Quelle figure centrale juge les √¢mes ?", answer:" Le christ", hint:"Au centre du mur" }
  ]},
  { id:'salle2', name:'Chambres de Rapha√´l', works:[
    { id:'oeuvre3', title:"Rapha√´l ‚Äì √âcole d‚ÄôAth√®nes", question:"Quels deux philosophes dominent au centre ?", answer:"platon et aristote", hint:"Avec la Tim√©e et L'√©thique" },
    { id:'oeuvre4', title:"Rapha√´l ‚Äì Couronnement de Charlemagne", question:"Cette fresque fait tr√®s probablement allusion au concordat sign√© entre le Saint-Si√®ge et le royaume de France en 1515 dans la mesure o√π L√©on III (pape de 795 √† 816) porte les traits de XXX et Charlemagne ceux de xxx.", answer:"L√©on X et Fran√ßois I", hint:"Pape et Roi de France" }
  ]},
  { id:'salle3', name:'Galerie des cartes', works:[
    { id:'oeuvre5', title:"Cartes des ports ", question:"Quels sont les 4 ports principaux de l'√©poque ?", answer:"Anc√¥ne, Civitavecchia, G√™nes, Venise", hint:"Par ordre alphab√©tique" },
    { id:'oeuvre6', title:"Carte d'une √Æle", question:"Quel √Æle est repr√©sent√©e ?", answer:"√éle d'Elbe", hint:"Napol√©on" }
  ]},
  { id:'salle5', name:'Pinacoth√®que', works:[
    { id:'oeuvre9', title:"Rapha√´l ‚Äì La Transfiguration", question:"De qui est entour√© le Christ ? ", answer:"Mo√Øse et Elie", hint:"Fontaine disproportionn√©e et Semoun" },
    { id:'oeuvre10', title:"L√©onard de Vinci ‚Äì Saint J√©r√¥me", question:"En combien de morceaux avait √©t√© coup√© ce tableau ?  ?", answer:"5", hint:"" }
  ]},
  { id:'salle6', name:'Cour de l‚ÄôOctogone', works:[
    { id:'oeuvre11', title:"Laocoon et ses fils", question:"Quels animaux mythiques attaquent les personnages ?", answer:"serpents", hint:"Deux enroul√©s" },
    { id:'oeuvre12', title:"Apollon du Belv√©d√®re", question:"Quelle arme manie-t-il ?", answer:"arc", hint:"Chasseur" }
  ]},
  { id:'salle8', name:'Mus√©e √âtrusque', works:[
    { id:'oeuvre15', title:"Chim√®re d‚ÄôArezzo", question:"Quel animal forme sa t√™te principale ?", answer:"lion", hint:"Triple cr√©ature" },
    { id:'oeuvre16', title:"Urne fun√©raire peinte", question:"Quel type de sc√®ne y est repr√©sent√© ?", answer:"banquet", hint:"F√™te fun√©raire" }
  ]},
  { id:'salle9', name:'Collection d‚Äôart moderne', works:[
    { id:'oeuvre17', title:"Matisse ‚Äì La Vierge √† l'Enfant", question:"Combien de temps Matisse a-t-il mis pour la r√©aliser ? ", answer:"4 ans", hint:"Entre 2 coupes du monde" },
    { id:'oeuvre18', title:"Chagall ‚Äì Le Christ et le peintre", question:"O√π este Chagall ?", answer:"A droite", hint:"Titre indicatif" }
  ]},
  { id:'salle10', name:'Mus√©e Pio-Clementino', works:[
    { id:'oeuvre19', title:"Torse du Belv√©d√®re", question:"D'apr√®s l‚Äôhypoth√®se actuellement la plus suivie, a quel h√©ros grec est identifi√© le buste ? Il est en train de m√©diter son suicide. ", answer:"Ajax T√©lamonius", hint:"On raconte qu‚Äôau cours de la guerre de Troie, le guerrier fut frapp√© de folie quand Ulysse lui enleva les armes d‚ÄôAchille. Ca c'est pour √™tre s√ªr que tu n'ais pas 100%" },
    { id:'oeuvre20', title:"Hercule Farn√®se", question:"Quel objet tient-il derri√®re le dos ?", answer:"pomme", hint:"Des Hesp√©rides" }
  ]}
];

    // Partie 3 ‚Äî Point A (objectif final) + vid√©o
    const FINALE = { lat:41.885427178724015,  lng: 12.450170605943002  , radius:10, youtube:"https://youtube.com/shorts/GxVgj9djLY4?feature=shareQ" };
    // Partie 3 ‚Äî Point B (d√©clencheur d'affichage de la carte P3 √† 1500 m)
    const P3_B = { lat:41.88423944494254,   lng:12.444860739662069, radius:800 };

    const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const TILE_ATTRIB = '&copy; contributeurs <a href="https://www.openstreetmap.org/">OpenStreetMap</a>';
    const START_VIEW = [41.8986, 12.4769];
    const START_ZOOM = 15;
    const GEO_OPTIONS = { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 };

    // ========= 2) UTIL ========
    const normalize = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase();
    const storageKey = (k)=> `rome-game-${k}`;
    const save = (k,v)=> localStorage.setItem(storageKey(k), JSON.stringify(v));
    const load = (k,def)=> { try{ return JSON.parse(localStorage.getItem(storageKey(k))) ?? def; } catch{ return def; } };

    // States persist√©s
    const progress   = load('progress', {});       // Partie 1: { id: 'locked'|'unlocked'|'started'|'done' }
    const p1Override = load('p1Override', false);  // gage ‚Üí 100%
    const p2State    = load('p2State', {});        // Partie 2: { salleId: { oeuvreId: 'done' } }
    const p2Override = load('p2Override', false);
    // Nouvelles persistance des r√©ponses valid√©es
    const p1Answers = load('p1Answers', {});   // { placeId: 'r√©ponse' }
    const p2Answers = load('p2Answers', {});   // { 'roomId.workId': 'r√©ponse' }
    const p3VictoryState = false;

    // ========= 3) PARTIE 1 ‚Äî CARTE ========
    const map = L.map('map');
    L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(map);
    map.setView(START_VIEW, START_ZOOM);

    map.on('popupopen', (e) => {
      const el = e.popup && e.popup.getElement ? e.popup.getElement() : (e.popup && e.popup._container);
      if (el) { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); }
    });

    const IconLocked = new L.DivIcon({ className:'icon-locked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #718096;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîí</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconUnlocked = new L.DivIcon({ className:'icon-unlocked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #38a169;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîì</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconDone = new L.DivIcon({ className:'icon-done', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #2b6cb0;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">‚úÖ</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });

    const placesLayer = L.layerGroup().addTo(map);
    let userMarker = null, accuracyCircle = null;

    const placesList = document.getElementById('placesList');
// ===== NAV HAUT (Partie 1/2/3) et bouton ‚ò∞ pour replier/afficher =====
	const panel = document.querySelector('.panel');
	const btnPanelToggle = document.getElementById('btnPanelToggle');
	if(btnPanelToggle){
      btnPanelToggle.addEventListener('click', ()=>{
		if(!panel) return;
		const isCollapsed = panel.classList.toggle('collapsed');
		btnPanelToggle.textContent = isCollapsed ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
	  });
	}
    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
      const el = document.getElementById(id); if(el) el.classList.add('visible');
      document.querySelectorAll('#topNav .nav-item').forEach(b=>{
        b.classList.toggle('active', b.getAttribute('data-target')===id);
      });
      // Panneau bas seulement en Partie 1
      const panel = document.querySelector('.panel');
      if(panel) panel.style.display = (id==='part1') ? 'flex' : 'none';
      // Bouton de toggle du panneau : visible seulement en Partie 1
      const panelToggleWrap = document.querySelector('.panel-toggle');
      if(panelToggleWrap) panelToggleWrap.style.display = (id==='part1') ? 'block' : 'none';
      setTimeout(()=>{
        try{ if(id==='part1') map.invalidateSize(); }catch(e){}
        try{ if(id==='part3' && typeof p3Map!=='undefined' && p3Map) p3Map.invalidateSize(); }catch(e){}
      },120);
    }
    document.querySelectorAll('#topNav .nav-item').forEach(btn=>{
      btn.addEventListener('click', ()=> showScreen(btn.getAttribute('data-target')));
    });
    const btnDrawer = document.getElementById('btnDrawer');
    btnDrawer?.addEventListener('click', ()=>{
      const top = document.getElementById('topNav');
      top.classList.toggle('collapsed');
    });
	
    function renderList(){
      placesList.innerHTML='';
      PLACES.forEach(p=>{
        const st = progress[p.id] || 'locked';
        const div = document.createElement('div');
        div.className = `place-row ${st}`;
        const answerTag = (st==='done' && p1Answers[p.id]) ? `<div class="hint">R√©ponse : <em>${p1Answers[p.id]}</em></div>` : `<div class="hint">rayon ${p.radius} m</div>`;
        div.innerHTML = `<div><strong>${p.name}</strong>${answerTag}</div><div class="right">${st==='done'?'‚úÖ': (st==='unlocked'||st==='started')?'üîì':'üîí'}</div>`;
        div.onclick = ()=> map.setView([p.lat,p.lng], 18, {animate:true});
        placesList.appendChild(div);
      });
      updateP1Progress();
    }

    function placePopupContent(p){
      const st = progress[p.id] || 'locked';
      if(st==='locked'){
        return `<div class="popup"><h3>${p.name}</h3><p>üîí Tu es trop loin. Approche √† <strong>${p.radius} m</strong>.</p></div>`;
      }
      if(st==='done'){
        const ans = p1Answers[p.id] ? `<p><strong>R√©ponse :</strong> ${p1Answers[p.id]}</p>` : '';
        return `<div class="popup"><h3>${p.name}</h3><p>‚úÖ D√©j√† valid√© !</p>${ans}</div>`;
      }
      if(st==='unlocked'){
        return `<div class="popup"><h3>${p.name}</h3><p>Tu es √† port√©e. Pr√™t(e)?</p><button onclick="event.stopPropagation(); window.__startChallenge('${p.id}'); return false;">Commencer le d√©fi</button></div>`;
      }
      // started
      return `<div class="popup"><h3>${p.name}</h3><p>${p.question}</p><input id="ans-${p.id}" type="text" placeholder="R√©ponse" autofocus onclick="event.stopPropagation();" onfocus="event.stopPropagation();" /><button onclick="event.stopPropagation(); window.__checkAnswer('${p.id}'); return false;">Valider</button><p class="hint">Indice : ${p.hint||'‚Äî'}</p></div>`;
    }

    const markersById = {}, lastPopupState = {};

    function addPlaceMarker(p){
      const st = progress[p.id] || 'locked';
      const m = L.marker([p.lat,p.lng], { icon: st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked });
      m.bindPopup(placePopupContent(p));
      m.on('popupopen', ()=> lastPopupState[p.id] = progress[p.id] || 'locked');
      m.addTo(placesLayer);
      markersById[p.id]=m;
    }
    function refreshMarker(p){
      const m = markersById[p.id];
      const st = progress[p.id] || 'locked';
      m.setIcon(st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked);
      m.setPopupContent(placePopupContent(p));
    }

    PLACES.forEach(addPlaceMarker);
    function renderMarkers(){ PLACES.forEach(refreshMarker); }

    window.__startChallenge = function(id){
      const p=PLACES.find(x=>x.id===id); if(!p) return;
      progress[id]='started'; save('progress',progress);
      refreshMarker(p); markersById[id].openPopup(); lastPopupState[id]='started';
      updateP1Progress();
    };

    window.__checkAnswer = function(id){
      const p=PLACES.find(x=>x.id===id); const input=document.getElementById(`ans-${id}`);
      if(!p||!input) return;
      const userVal = input.value;
      const ok = normalize(userVal)===normalize(p.answer);
      const gpsText=document.getElementById('gpsText');
      if(ok){
        progress[id]='done';
        p1Answers[id] = userVal; // conserve la r√©ponse telle que saisie
        save('progress',progress); save('p1Answers', p1Answers);
        refreshMarker(p); renderList();
        gpsText.textContent=`Bravo ! √âtape ¬´ ${p.name} ¬ª valid√©e.`; lastPopupState[id]='done';
      } else {
        gpsText.textContent='Mauvaise r√©ponse, essaie encore.'; input.focus(); input.select&&input.select();
      }
    };

    function updateP1Progress(){
      const total = PLACES.length;
      const done  = PLACES.filter(p=>progress[p.id]==='done').length;
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p1Override', false);
      if(override) pct=100;
      document.getElementById('p1Pct').textContent = pct+'%';
      document.getElementById('p1Bar').style.width = pct+'%';
      const key = document.getElementById('p1Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 4) PARTIE 2 ‚Äî ROOMS ========
    const roomsContainer = document.getElementById('rooms');
    function renderRooms(){
      roomsContainer.innerHTML='';
      ROOMS.forEach(room=>{
        const card=document.createElement('div'); card.className='room';
        card.innerHTML = `<h3>${room.name}</h3>`;
        const list=document.createElement('div');
        const state = p2State[room.id] || {};
        room.works.forEach(w=>{
          const done = state[w.id]==='done';
          const key = `${room.id}.${w.id}`;
          const savedVal = p2Answers[key] || '';
          const row=document.createElement('div'); row.className='work';
          row.innerHTML = `<div class=\"state\">${done?'‚úÖ':'üïµÔ∏è'}</div>
            <div class=\"title\" style=\"flex:1\"><strong>${w.title}</strong><div class=\"hint\">${w.question}</div></div>
            <input type=\"text\" id=\"w-${room.id}-${w.id}\" placeholder=\"R√©ponse\" ${done?'disabled':''} value=\"${done ? savedVal.replace(/\"/g,'\\"') : ''}\"/>
            <button data-room=\"${room.id}\" data-work=\"${w.id}\">${done?'R√©pondu':'Valider'}</button>`;
          list.appendChild(row);
        });
        card.appendChild(list);
        roomsContainer.appendChild(card);
      });
      roomsContainer.querySelectorAll('button[data-room]').forEach(btn=>{
        btn.onclick=()=>{
          const roomId=btn.getAttribute('data-room'); const workId=btn.getAttribute('data-work');
          const room=ROOMS.find(r=>r.id===roomId); const work=room.works.find(x=>x.id===workId);
          const input=document.getElementById(`w-${roomId}-${workId}`); if(!input) return;
          const ok=normalize(input.value)===normalize(work.answer);
          if(ok){
            // conserve la valeur telle que saisie
            const key = `${roomId}.${workId}`;
            p2State[roomId]=p2State[roomId]||{}; p2State[roomId][workId]='done';
            p2Answers[key] = input.value;
            save('p2State',p2State); save('p2Answers', p2Answers);
            renderRooms(); updateP2Progress();
          }else{ input.focus(); input.select&&input.select(); }
        };
      });
    }

    function updateP2Progress(){
      const total = ROOMS.reduce((s,r)=>s+r.works.length,0);
      const done  = ROOMS.reduce((s,r)=> s + (Object.values(p2State[r.id]||{}).filter(v=>v==='done').length), 0);
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p2Override', false);
      if(override) pct=100;
      document.getElementById('p2Pct').textContent = pct+'%';
      document.getElementById('p2Bar').style.width = pct+'%';
      const key = document.getElementById('p2Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 5) PARTIE 3 ‚Äî CL√âS + GEOFENCE + CARTE POINT B & CHAUD/FROID ========
    const p3Status=document.getElementById('p3Status');
    const p3Action=document.getElementById('p3Action');
    const p3Pct=document.getElementById('p3Pct');
    const p3Bar=document.getElementById('p3Bar');
    const victoryLink=document.getElementById('victoryLink'); victoryLink.href = FINALE.youtube;

    // Carte de la Partie 3
    const p3MapWrap = document.getElementById('p3MapWrap');
    let p3Map=null, p3UserMarker=null, p3BCircle=null, p3ACircle=null, p3AMarker=null;

    // D√©grad√© couleur du marqueur utilisateur selon distance au Point A
    function lerp(a,b,t){ return a + (b-a)*t; }
    function heatColor(distance){
      // Couleurs "froid -> chaud" en passant par vert/jaune/orange (pas de violet)
      // t = 0 (loin) ‚Üí bleu | t = 1 (tr√®s proche) ‚Üí rouge
      const MAX = 1500; // distance √† partir de laquelle on consid√®re "tr√®s loin"
      const clamp = (v,min,max)=> Math.min(max, Math.max(min, v));
      // Accentuer la sensibilit√© proche du but (courbe gamma)
      let t = 1 - clamp(distance / MAX, 0, 1);
      t = Math.pow(t, 0.7);
      const stops = [
        { t: 0.00, c: [30, 58, 138] },   // bleu
        { t: 0.25, c: [0, 170, 0] },     // vert
        { t: 0.50, c: [255, 215, 0] },   // jaune
        { t: 0.75, c: [255, 140, 0] },   // orange
        { t: 1.00, c: [220, 38, 38] }    // rouge
      ];
      function lerp(a,b,u){ return a + (b-a)*u; }
      function mix(c1,c2,u){ return [
        Math.round(lerp(c1[0], c2[0], u)),
        Math.round(lerp(c1[1], c2[1], u)),
        Math.round(lerp(c1[2], c2[2], u))
      ]; }
      // Trouver le segment correspondant
      for(let i=0;i<stops.length-1;i++){
        const a=stops[i], b=stops[i+1];
        if(t>=a.t && t<=b.t){
          const u = (t - a.t) / (b.t - a.t);
          const c = mix(a.c, b.c, u);
          return `rgb(${c[0]},${c[1]},${c[2]})`;
        }
      }
      const last = stops[stops.length-1].c; // fallback
      return `rgb(${last[0]},${last[1]},${last[2]})`;
    }
    function userDivIcon(color){
      return new L.DivIcon({
        className:'p3-user',
        html:`<div style="width:22px;height:22px;border:2px solid #fff;background:${color};border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.25)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    function updateP3FromKeys(){
      const k1=!document.getElementById('p1Key').hasAttribute('disabled');
      const k2=!document.getElementById('p2Key').hasAttribute('disabled');
      const pct=(k1?50:0)+(k2?50:0);
      p3Pct.textContent=pct+'%'; p3Bar.style.width=pct+'%';
      if(k1&&k2){ p3Status.textContent='‚úÖ Cl√©s r√©unies ! Devine le lieu √† partir des cl√©s et rechauffe toi pour trouver le point final et d√©bloquer ta r√©compense √©ternelle.'; p3Action.style.display='block'; }
      else { p3Status.innerHTML='üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.'; p3Action.style.display='none'; }
    }

    // ========= 6) G√âOLOCALISATION COMMUNE ========
    const gpsDot=document.getElementById('gpsDot');
    const gpsText=document.getElementById('gpsText');
    const accText=document.getElementById('accText');
    let watchId=null;
    function setStatus(kind,text,acc){ gpsDot.className='dot '+(kind||'err'); gpsText.textContent=text||''; accText.textContent=acc?`¬± ${Math.round(acc)} m`:'‚Äî'; }
    function ensureLocate(){ if(!('geolocation' in navigator)){ setStatus('err','G√©olocalisation non support√©e'); return; } if(watchId!==null) return; setStatus('warn','Demande de GPS‚Ä¶'); watchId=navigator.geolocation.watchPosition(onPos,onGeoError,GEO_OPTIONS); }
    function onGeoError(err){ setStatus('err',err.message||'Erreur de g√©olocalisation'); }

    const finaleCircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#2b6cb0', weight:1, fillOpacity:0.05 });

    function onPos(pos){
      const { latitude, longitude, accuracy } = pos.coords; const here=[latitude,longitude];
      // Marqueur utilisateur (Partie 1)
      if(!userMarker){ userMarker=L.marker(here,{title:'Vous'}).addTo(map); } else { userMarker.setLatLng(here); }
      if(!accuracyCircle){ accuracyCircle=L.circle(here,{radius:accuracy,weight:1,fillOpacity:0.1}).addTo(map); } else { accuracyCircle.setLatLng(here).setRadius(accuracy); }
      setStatus('ok','GPS actif',accuracy);

      // D√©verrouillage P1
      PLACES.forEach(p=>{
        const prev=progress[p.id]||'locked';
        const d=map.distance(here,[p.lat,p.lng]); const r=p.radius||20;
        if(d<=r && prev==='locked'){
          progress[p.id]='unlocked'; save('progress',progress);
          refreshMarker(p); renderList(); markersById[p.id].openPopup(); lastPopupState[p.id]='unlocked';
        }
        const curr=progress[p.id]||'locked'; const m=markersById[p.id];
        if(m.isPopupOpen()){
          if(curr==='locked'){
            m.setPopupContent(`<div class="popup"><h3>${p.name}</h3><p>üîí Tu es √† <strong>${Math.round(d)} m</strong>. Approche √† moins de <strong>${r} m</strong>.</p></div>`);
            lastPopupState[p.id]='locked';
          } else if(lastPopupState[p.id]!==curr){ m.setPopupContent(placePopupContent(p)); lastPopupState[p.id]=curr; }
        }
      });

      // Partie 3 : Carte conditionnelle autour de B + couleur ‚Äúchaud/froid‚Äù vers A
      const keysOK = !document.getElementById('p1Key').hasAttribute('disabled') && !document.getElementById('p2Key').hasAttribute('disabled');
      if(keysOK){
        const dB = map.distance(here, [P3_B.lat, P3_B.lng]);
        if(dB <= (P3_B.radius||1500)){
          // Afficher/initialiser carte P3
          p3MapWrap.style.display='block';
          if(!p3Map){
            p3Map = L.map('mapP3');
            L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(p3Map);
            p3Map.setView([P3_B.lat, P3_B.lng], 15);
            p3BCircle = L.circle([P3_B.lat, P3_B.lng], { radius: P3_B.radius, color:'#2b6cb0', weight:1, fillOpacity:0.03 }).addTo(p3Map);
            // p3ACircle : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
            // p3AMarker : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
          }
          // Mettre √† jour marqueur utilisateur P3 + couleur
          const dA = map.distance(here, [FINALE.lat, FINALE.lng]);
          const color = heatColor(dA);
          if(!p3UserMarker){ p3UserMarker = L.marker(here, { icon: userDivIcon(color) }).addTo(p3Map); }
          else { p3UserMarker.setLatLng(here); p3UserMarker.setIcon(userDivIcon(color)); }
          // Afficher/masquer le Point A uniquement dans un rayon de 10 m
          if(dA <= (FINALE.radius||10)){
            if(!p3AMarker){ p3AMarker = L.marker([FINALE.lat, FINALE.lng], { title:'Point A (objectif)' }).addTo(p3Map); }
            if(!p3ACircle){ p3ACircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#dc2626', weight:1, fillOpacity:0.06 }).addTo(p3Map); }
          } else {
            if(p3AMarker){ p3Map.removeLayer(p3AMarker); p3AMarker = null; }
            if(p3ACircle){ p3Map.removeLayer(p3ACircle); p3ACircle = null; }
          }
          // Victoire √† 10 m
          if(dA <= (FINALE.radius||10)){
            p3Status.textContent='üéØ Point final atteint !';
            const v = document.getElementById('p3Victory');
            if(v){ v.removeAttribute('disabled'); v.setAttribute('open',''); }
            p3Action.style.display='none';
          } else {
            const v = document.getElementById('p3Victory');
            if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); }
          }
        } else {
          // Hors zone de B ‚Üí cacher la carte P3
          p3MapWrap.style.display='none';
        }
      }
    }

    // ========= 7) NAV + BOUTONS ========
    document.getElementById('btnLocate').addEventListener('click', ()=>{ ensureLocate(); if(userMarker) map.setView(userMarker.getLatLng(), 17, {animate:true}); });
    document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('R√©initialiser toute la progression ?')) return; localStorage.clear(); location.reload(); });

    document.getElementById('p1GageDone').addEventListener('click', ()=>{ save('p1Override', true); updateP1Progress(); alert('Partie 1 valid√©e √† 100%'); });
    document.getElementById('p2GageDone').addEventListener('click', ()=>{ save('p2Override', true); updateP2Progress(); alert('Partie 2 valid√©e √† 100%'); });

    const drawerBtn=document.getElementById('btnDrawer');
    const navButtons=[...document.querySelectorAll('#drawer .nav-item')];
    drawerBtn.addEventListener('click', ()=>{ const d=document.getElementById('drawer'); d.style.display=(d.style.display==='none'?'block':'none'); });
    navButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const target=btn.getAttribute('data-target');
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
      document.getElementById(target).classList.add('visible');
      if(target==='part1'){ setTimeout(()=> map.invalidateSize(), 50); }
      if(target==='part3' && p3Map){ setTimeout(()=> p3Map.invalidateSize(), 50); }
    }));

    // ====== Contr√¥le d'acc√®s √† la Partie 2 (verrou si Partie 1 < 100%) ======
    const btnPart2 = document.querySelector('#drawer .nav-item[data-target="part2"]');
    function updatePart2Lock(){
      const allowed = !document.getElementById('p1Key').hasAttribute('disabled');
      if(allowed){
        btnPart2 && btnPart2.removeAttribute('disabled');
        if(btnPart2) btnPart2.title = 'üñºÔ∏è Partie 2 ‚Äî Vatican';
      } else {
        btnPart2 && btnPart2.setAttribute('disabled','');
        if(btnPart2) btnPart2.title = 'üîí Termine d\'abord la Partie 1 (100%)';
        // Si on est d√©j√† sur la Partie 2, on renvoie vers la Partie 1
        if(document.getElementById('part2').classList.contains('visible')){
          const btnP1 = document.querySelector('#drawer .nav-item[data-target="part1"]');
          btnP1 && btnP1.click();
        }
      }
    }
    // Bloque les clics sur le bouton Part 2 quand il est d√©sactiv√© (s√©curit√© suppl√©mentaire)
    document.addEventListener('click', (e)=>{
      const t = e.target.closest && e.target.closest('#drawer .nav-item[data-target="part2"]');
      if(t && t.hasAttribute('disabled')){ e.preventDefault(); e.stopPropagation(); alert('üîí Termine d\'abord la Partie 1 (100%) pour acc√©der √† la Partie 2.'); }
    });

    // ========= 8) RENDER INIT ========
    PLACES.forEach(addPlaceMarker); renderList();
    renderRooms(); updateP2Progress();
    updateP1Progress(); updateP3FromKeys(); updatePart2Lock();
    // Si la victoire a d√©j√† √©t√© atteinte dans une session pr√©c√©dente, d√©bloquer le dossier
    { const v=document.getElementById('p3Victory'); if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); } } 
    // iOS : demander d'appuyer sur üìç pour activer la g√©oloc
  </script>
</body>
</html>