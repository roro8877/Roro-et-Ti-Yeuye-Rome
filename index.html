<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jeu de piste Rome ‚Äì Carte interactive</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{--brand:#2b6cb0;--ok:#2f855a;--warn:#b7791f;--err:#c53030;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';}
    /* Mise en page avec menu */
    #app.with-drawer{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;min-height:100vh;}
    #drawer{grid-row:1/span 2;grid-column:1;background:#0f2747;color:#fff;padding:12px;display:block;}
    #drawer .drawer-header{font-weight:700;margin-bottom:10px;}
    #drawer .nav-item{width:100%;text-align:left;background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;cursor:pointer}
    #drawer .nav-item.active,#drawer .nav-item:hover{background:rgba(255,255,255,.12)}
    #drawer .nav-item[disabled]{opacity:.5; pointer-events:none; cursor:not-allowed;}
    header{grid-column:2;padding:10px 14px;background:var(--brand);color:#fff;position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .btn{border:0;background:rgba(255,255,255,.15);color:#fff;padding:8px 10px;border-radius:10px;font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#edf2f7;border-radius:999px;padding:4px 8px;font-size:12px;color:#1a202c}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* √âcrans */
    .screen{grid-column:2;display:none;position:relative}
    .screen.visible{display:block}
	/* Quand le menu de gauche est repli√©, header + √©crans se placent sur la 1√®re colonne */
    #app.without-drawer header, #app.without-drawer .screen{grid-column:1;}
    /* Carte + panneaux */
    #map{height:calc(100vh - 70px)}
    #mapP3{height:60vh;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-top:10px}
    .panel{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:10px;z-index:1001}
    .card{flex:1;background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:10px}
    .status{font-size:12px;color:#333;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .status .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .status .ok{background:var(--ok)} .status .warn{background:var(--warn)} .status .err{background:var(--err)}
    .places{max-height:28vh;overflow:auto;margin-top:6px;font-size:14px}
    .place-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px}
    .place-row + .place-row{margin-top:6px}
    .place-row.locked{background:#f7fafc}
    .place-row.unlocked,.place-row.started{background:#f0fff4}
    .place-row.done{background:#edf2f7;text-decoration:line-through;color:#4a5568}
    .place-row .right{font-size:12px;color:#4a5568}
    .fab{position:fixed;right:16px;top:60px;z-index:1001}
    .fab button{border:0;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.2);border-radius:999px;padding:10px 12px}
    .leaflet-popup-content{margin:10px}
    .popup h3{margin:0 0 8px 0;font-size:16px}
    .popup p{margin:0 0 8px 0}
    .popup input{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e0;margin-bottom:8px}
    .popup button{width:100%;padding:10px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:600}
    .hint{font-size:12px;color:#4a5568}
	/* Quand le menu est repli√© (mobile), header et √©cran occupent la 1re colonne */
    #app.without-drawer header,
    #app.without-drawer .screen { grid-column: 1; }

    /* Panneau bas repliable */
	.panel { position:fixed; left:10px; right:10px; bottom:10px; display:flex; gap:10px; z-index:1001; transition:transform .25s ease, opacity .25s ease; }
	.panel.collapsed { transform: translateY(110%); opacity:0; pointer-events:none; }

	.panel-toggle { position:fixed; right:16px; bottom:16px; z-index:1002; }
	.panel-toggle button{ border:0; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.2); border-radius:999px; padding:10px 12px; }

	/* Sur petits √©crans, on r√©duit l‚Äôent√™te */
	@media (max-width: 900px){
      header h1{ font-size:14px }
	}

    /* Progress bars */
    .progress{margin:8px 0 10px}
    .progress-row{font-size:14px;margin-bottom:6px}
    .bar{background:#e2e8f0;border-radius:999px;height:10px;overflow:hidden}
    .bar span{display:block;height:100%;background:var(--brand)}
    details.key[disabled] summary { color:#718096; }
    details.key[disabled] { pointer-events: none; opacity: 0.7; }
    details.key[disabled] .key-content { display: none; }
    /* Partie 2 : rooms/works */
    .rooms{padding:12px;display:grid;gap:12px}
    .room{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:10px}
    .room h3{margin-top:0}
    .work{display:flex;gap:8px;align-items:center;padding:6px 0}
    .work .state{width:22px;text-align:center}
    .work input[type=text]{flex:1;padding:8px;border-radius:8px;border:1px solid #cbd5e0}
    .work button{padding:8px 10px;border-radius:8px;border:0;background:var(--brand);color:#fff}
    .btn.small{padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <div id="app" class="with-drawer">
    <aside id="drawer">
      <div class="drawer-header">Menu</div>
      <nav>
        <button class="nav-item active" data-target="part1">üó∫Ô∏è Partie 1 ‚Äî Rome</button>
        <button class="nav-item" data-target="part2">üñºÔ∏è Partie 2 ‚Äî Vatican</button>
        <button class="nav-item" data-target="part3">üå≥ Partie 3 ‚Äî Finale</button>
      </nav>
    </aside>

    <header>
      <button id="btnDrawer" class="btn" title="Ouvrir le menu">‚ò∞</button>
      <h1>Jeu de piste Rome</h1>
      <div class="legend">
        <span class="badge">üîí verrouill√©</span>
        <span class="badge">üîì √† port√©e</span>
        <span class="badge">‚úÖ valid√©</span>
      </div>
      <button id="btnReset" class="btn" title="R√©initialiser la progression">R√©initialiser</button>
    </header>

    <!-- ===== PARTIE 1 : CARTE & D√âFIS ROME ===== -->
    <section id="part1" class="screen visible">
      <div id="map"></div>

      <div class="fab">
        <button id="btnLocate" title="Me localiser">üìç</button>
      </div>
	  <div class="panel-toggle">
		<button id="btnPanelToggle" title="Afficher / masquer le panneau">‚¨ÜÔ∏è</button>
	  </div>


      <div class="panel">
        <div class="card">
          <div class="status" id="gpsStatus">
            <div><span class="dot err" id="gpsDot"></span><span id="gpsText">GPS inactif</span></div>
            <div><span id="accText">‚Äî</span></div>
          </div>
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 1</strong> ‚Äî <span id="p1Pct">0%</span></div>
            <div class="bar"><span id="p1Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p1Gages">
            <summary>üé≤ Gages (clique pour voir)</summary>
            <ul>
              <li><label><input type="radio" name="p1gage" value="0-20"> 0‚Äì20% : Paie le restaurant √† tout le groupe</label></li>
              <li><label><input type="radio" name="p1gage" value="20-40"> 20‚Äì40% : Paie ta tourn√©e</label></li>
              <li><label><input type="radio" name="p1gage" value="40-60"> 40‚Äì60% : Paie une glace √† l'organisateur</label></li>
              <li><label><input type="radio" name="p1gage" value="60-80"> 60‚Äì80% : Fais un discours en italien</label></li>
              <li><label><input type="radio" name="p1gage" value="80-99"> 80‚Äì99% : Selfie statue + pose gladiateur</label></li>
            </ul>
            <button id="p1GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 1 √† 100%</button>
          </details>
          <details id="p1Key" class="key" disabled>
            <summary>üìÅ Cl√© 1 (d√©bloqu√©e √† 100%)</summary>
            <div class="key-content"><strong>Blanc</strong></div>
          </details>
          <div class="places" id="placesList"></div>
        </div>
      </div>
    </section>

    <!-- ===== PARTIE 2 : MUS√âES DU VATICAN ===== -->
    <section id="part2" class="screen">
      <div class="vatican">
        <div class="card">
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 2</strong> ‚Äî <span id="p2Pct">0%</span></div>
            <div class="bar"><span id="p2Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p2Gages">
            <summary>üé≤ Gages (clique pour voir)</summary>
            <ul>
              <li><label><input type="radio" name="p2gage" value="0-20"> 0‚Äì20% : Paie le restaurant √† tout le groupe</label></li>
              <li><label><input type="radio" name="p2gage" value="20-40"> 20‚Äì40% : Paie ta tourn√©e</label></li>
              <li><label><input type="radio" name="p2gage" value="40-60"> 40‚Äì60% : Paie une glace √† l'organisateur</label></li>
              <li><label><input type="radio" name="p2gage" value="60-80"> 60‚Äì80% : D√©cris une ≈ìuvre en mimant</label></li>
              <li><label><input type="radio" name="p2gage" value="80-99"> 80‚Äì99% : Selfie couloir des cartes</label></li>
            </ul>
            <button id="p2GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 2 √† 100%</button>
          </details>
          <details id="p2Key" class="key" disabled>
            <summary>üìÅ Cl√© 2 (d√©bloqu√©e √† 100%)</summary>
            <div class="key-content"><strong>Visage</strong></div>
          </details>
        </div>

        <div class="rooms" id="rooms"></div>
      </div>
    </section>

    <!-- ===== PARTIE 3 : FINALE ===== -->
    <section id="part3" class="screen">
      <div class="card">
        <h2>Finale ‚Äî Trouve le parc</h2>
        <p>Assemble les deux cl√©s pour r√©v√©ler le lieu final. Va au <strong>Point A</strong> (10 m) pour d√©bloquer la vid√©o de victoire.</p>
        <div id="p3Status" class="hint">üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.</div>
        <div class="progress">
          <div class="progress-row"><strong>Avanc√©e</strong> ‚Äî <span id="p3Pct">0%</span></div>
          <div class="bar"><span id="p3Bar" style="width:0%"></span></div>
        </div>
        <div id="p3Action" style="display:none">
          <p>Dirige-toi vers le point final (rayon 10 m). Quand tu y es, ouvre le dossier <strong>Victoire</strong>.</p>
        </div>
        <!-- Dossier Victoire (d√©bloqu√© uniquement quand le Point A est atteint) -->
        <details id="p3Victory" class="key" disabled>
          <summary>üìÅ Victoire</summary>
          <div class="key-content"><a id="victoryLink" href="#" target="_blank" class="btn">üéâ Voir la vid√©o</a></div>
        </details>
        <!-- Carte de la Partie 3 (affich√©e seulement si ‚â§ 1500 m de B et cl√©s OK) -->
        <div id="p3MapWrap" style="display:none">
          <div id="mapP3"></div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ========= 1) CONFIG =========
	
    const PLACES = [
	 // ‚Äî Florence (exemples) ‚Äî
  { id:'f_duomo', name:'Piazza del Duomo (Florence)', lat:43.773449, lng:11.256236, radius:20,
    question:"Quelle fleur appara√Æt sur le bas-relief central de la fa√ßade du Duomo ?", answer:"lys", hint:"symbole des M√©dicis" },
  { id:'f_ponte_vecchio', name:'Ponte Vecchio', lat:43.768009, lng:11.253165, radius:20,
    question:"Quel m√©tal orne les petites plaques des boutiques du pont ?", answer:"or", hint:"m√©tal pr√©cieux jaune" },
  { id:'f_uffizi', name:'Galerie des Offices (Uffizi)', lat:43.767788, lng:11.255256, radius:20,
    question:"Quel peintre a sa ¬´ Naissance de V√©nus ¬ª dans cette galerie ?", answer:"botticelli", hint:"premier nom : Sandro" },
  { id:'f_santacroce', name:'Basilique Santa Croce', lat:43.768728, lng:11.260036, radius:20,
    question:"Quel grand artiste est enterr√© dans cette √©glise ?", answer:"michelangelo", hint:"sculpteur de la Chapelle Sixtine" },
  { id:'f_signoria', name:'Piazza della Signoria', lat:43.769006, lng:11.255860, radius:20,
    question:"Quelle statue de h√©ros biblique se tient devant le Palazzo Vecchio ici ?", answer:"david", hint:"statue de Michel-Ange (r√©plique)" },
  { id:'f_santilorenzo', name:'Basilique San Lorenzo', lat:43.777494, lng:11.253180, radius:20,
    question:"Quel nom porte la chapelle construite par les M√©dicis ici ?", answer:"cappelle medicee", hint:"chapelle M√©dicis" },
  { id:'f_palazzopitti', name:'Palazzo Pitti', lat:43.764759, lng:11.251686, radius:20,
    question:"Quel jardin royal se trouve derri√®re ce palais ?", answer:"boboli", hint:"Jardin de Boboli" },
  { id:'f_piazzamelanogelo', name:'Piazzale Michelangelo', lat:43.762900, lng:11.258601, radius:20,
    question:"Quel monument domine la vue sur Florence depuis cette terrasse ?", answer:"le duomo", hint:"coupole imposante" },
  { id:'f_palazzo_vecchio', name:'Palazzo Vecchio', lat:43.769513, lng:11.255840, radius:20,
    question:"Quelle tour domine la loggia de ce palais ?", answer:"tour d'arnolfo", hint:"Arnolfo di Cambio" },
  { id:'f_basilicasanmarco', name:'Basilique San Marco', lat:43.775000, lng:11.252000, radius:20,
    question:"Quel moine dominicain c√©l√®bre y r√©sida ?", answer:"savonarole", hint:"pr√©dicateur florentin" },
  // ‚Äî Rome (quelques exemples) ‚Äî
	{ id:'r_colosseo', name:'Colis√©e', lat:41.8902, lng:12.4922, radius:20, question:"Combien d‚Äôentr√©es principales comptait l‚Äôamphith√©√¢tre √† l‚Äô√©poque romaine ?", answer:"80", hint:"Nombre rond, tr√®s grand" },
{ id:'r_arco_costantino', name:'Arc de Constantin', lat:41.8898, lng:12.4900, radius:20, question:"Quel empereur est honor√© par cet arc ?", answer:"constantin", hint:"Empereur converti au christianisme" },
{ id:'r_forum_romanum', name:'Forum Romain', lat:41.8925, lng:12.4853, radius:20, question:"Quel temple d√©di√© √† un dictateur assassin√© se trouve ici ?", answer:"temple de c√©sar", hint:"Divus Iulius" },
{ id:'r_palatino', name:'Colline du Palatin', lat:41.8892, lng:12.4885, radius:20, question:"Quel animal aurait allait√© Romulus et R√©mus ?", answer:"louve", hint:"Symbole de Rome" },
{ id:'r_circo_massimo', name:'Circus Maximus', lat:41.8852, lng:12.4856, radius:20, question:"Quelle course s‚Äôy d√©roulait principalement ?", answer:"courses de chars", hint:"Quadriges" },
{ id:'r_pantheon', name:'Panth√©on', lat:41.8986, lng:12.4769, radius:20, question:"Comment s‚Äôappelle l‚Äôouverture circulaire au sommet de la coupole ?", answer:"oculus", hint:"Mot latin" },
{ id:'r_piazza_navona', name:'Piazza Navona', lat:41.8992, lng:12.4731, radius:20, question:"Combien d‚Äôob√©lisques compte la fontaine centrale ?", answer:"1", hint:"Un seul" },
{ id:'r_fontana_trevi', name:'Fontaine de Tr√©vi', lat:41.9009, lng:12.4833, radius:20, question:"Combien de pi√®ces lancer pour assurer un retour √† Rome ?", answer:"1", hint:"La tradition" },
{ id:'r_scala_spagna', name:'Escalier de la Trinit√©-des-Monts', lat:41.9059, lng:12.4823, radius:20, question:"Au pied des marches, quelle place c√©l√®bre ?", answer:"piazza di spagna", hint:"Nom de la place" },
{ id:'r_trinita_monti', name:'Trinit√† dei Monti', lat:41.9066, lng:12.4829, radius:20, question:"Combien de clochers encadrent la fa√ßade ?", answer:"2", hint:"Sym√©trie" },
{ id:'r_piazza_venezia', name:'Piazza Venezia', lat:41.8947, lng:12.4824, radius:20, question:"Quel surnom donne-t-on au monument blanc √† Victor-Emmanuel II ?", answer:"machine √† √©crire", hint:"Surnom moderne" },
{ id:'r_vittoriano', name:'Vittoriano (Autel de la Patrie)', lat:41.8949, lng:12.4823, radius:20, question:"Quel soldat y est honor√© comme ¬´ inconnu ¬ª ?", answer:"soldat inconnu", hint:"Tombe symbolique" },
{ id:'r_campidoglio', name:'Piazza del Campidoglio', lat:41.8931, lng:12.4825, radius:20, question:"Quel artiste a dessin√© le plan de la place ?", answer:"michel-ange", hint:"Renaissance" },
{ id:'r_bocca_verita', name:'Bocca della Verit√†', lat:41.8881, lng:12.4791, radius:20, question:"Dans quoi faut-il mettre la main selon la l√©gende ?", answer:"la bouche", hint:"Disque de marbre" },
{ id:'r_isola_tiberina', name:'Isola Tiberina', lat:41.8907, lng:12.4783, radius:20, question:"Quel fleuve entoure l‚Äô√Æle ?", answer:"tibre", hint:"Fleuve de Rome" },
{ id:'r_castel_santangelo', name:'Castel Sant‚ÄôAngelo', lat:41.9031, lng:12.4663, radius:20, question:"Quel pont orn√© de statues y m√®ne ?", answer:"ponte sant'angelo", hint:"Pont des anges" },
{ id:'r_ponte_santangelo', name:'Ponte Sant‚ÄôAngelo', lat:41.9022, lng:12.4669, radius:20, question:"Combien d‚Äôanges bordent le pont (de chaque c√¥t√© confondus) ?", answer:"10", hint:"Deux chiffres" },
{ id:'r_piazza_san_pietro', name:'Place Saint-Pierre', lat:41.9022, lng:12.4564, radius:20, question:"Qui a dessin√© la colonnade ovale ?", answer:"le bernin", hint:"Bernini" },
{ id:'r_via_conciliazione', name:'Via della Conciliazione', lat:41.9029, lng:12.4630, radius:20, question:"Quel grand √©difice se voit au bout de l‚Äôavenue ?", answer:"basilique saint-pierre", hint:"D√¥me" },
{ id:'r_gianicolo', name:'Belv√©d√®re du Janicule', lat:41.8923, lng:12.4618, radius:20, question:"√Ä midi, qu‚Äôentend-on chaque jour depuis 1904 ?", answer:"un coup de canon", hint:"Tradition" },
{ id:'r_trastevere_basilica', name:'Santa Maria in Trastevere', lat:41.8896, lng:12.4692, radius:20, question:"Quelle mati√®re scintille sur l‚Äôabside ?", answer:"or", hint:"Mosa√Øques" },
{ id:'r_portico_ottavia', name:'Portique d‚ÄôOctavie', lat:41.8927, lng:12.4764, radius:20, question:"Dans quel quartier historique est-il situ√© ?", answer:"ghetto", hint:"Quartier juif" },
{ id:'r_teatro_marcello', name:'Th√©√¢tre de Marcellus', lat:41.8922, lng:12.4797, radius:20, question:"Avec quel monument est-il souvent confondu ?", answer:"colis√©e", hint:"Amphith√©√¢tre" },
{ id:'r_largo_argentina', name:'Largo di Torre Argentina', lat:41.8963, lng:12.4768, radius:20, question:"Que trouve-t-on aujourd‚Äôhui parmi les ruines (animaux) ?", answer:"chats", hint:"Refuge" },
{ id:'r_ara_pacis', name:'Ara Pacis', lat:41.9086, lng:12.4768, radius:20, question:"√Ä quel empereur est associ√©e cette autel ?", answer:"auguste", hint:"Pax Augusta" },
{ id:'r_mausoleo_augusto', name:'Mausol√©e d‚ÄôAuguste', lat:41.9069, lng:12.4762, radius:20, question:"Quel empereur y est enterr√© ?", answer:"auguste", hint:"Le premier empereur" },
{ id:'r_piazza_del_popolo', name:'Piazza del Popolo', lat:41.9109, lng:12.4768, radius:20, question:"Quel monument se dresse au centre ?", answer:"ob√©lisque", hint:"Aiguille √©gyptienne" },
{ id:'r_villa_borghese', name:'Parc de la Villa Borghese', lat:41.9122, lng:12.4923, radius:20, question:"Quel mus√©e c√©l√®bre se trouve dans le parc ?", answer:"galerie borgh√®se", hint:"Chef-d‚Äô≈ìuvres du Bernin" },
{ id:'r_galleria_borghese', name:'Galleria Borghese', lat:41.9142, lng:12.4923, radius:20, question:"Quel sculpteur baroque y brille particuli√®rement ?", answer:"bernini", hint:"Le Bernin" },
{ id:'r_maxxi', name:'MAXXI (Mus√©e du XXIe)', lat:41.9270, lng:12.4666, radius:20, question:"Quelle architecte a sign√© le b√¢timent ?", answer:"zaha hadid", hint:"Architecture fluide" },
{ id:'r_auditorium', name:'Auditorium Parco della Musica', lat:41.9297, lng:12.4687, radius:20, question:"Quel mat√©riau chaleureux recouvre l‚Äôint√©rieur ?", answer:"bois", hint:"Acoustique" },
{ id:'r_piazza_barberini', name:'Piazza Barberini ‚Äì Triton', lat:41.9033, lng:12.4892, radius:20, question:"Quel sculpteur a r√©alis√© la fontaine du Triton ?", answer:"le bernin", hint:"Baroque" },
{ id:'r_fontana_ape', name:'Fontaine des Abeilles', lat:41.9040, lng:12.4886, radius:20, question:"Quel insecte figure sur la fontaine ?", answer:"abeilles", hint:"Blason Barberini" },
{ id:'r_quirinale', name:'Palais du Quirinal', lat:41.8992, lng:12.4882, radius:20, question:"Qui y r√©side aujourd‚Äôhui (fonction) ?", answer:"pr√©sident de la r√©publique", hint:"Chef d‚Äô√âtat italien" },
{ id:'r_quattro_fontane', name:'Croisement des Quattro Fontane', lat:41.9035, lng:12.4929, radius:20, question:"Combien de fontaines √† ce carrefour ?", answer:"4", hint:"Le nom le dit" },
{ id:'r_s_maria_vittoria', name:'Santa Maria della Vittoria', lat:41.9045, lng:12.4946, radius:20, question:"Quel groupe c√©l√®bre s‚Äôy trouve (sainte) ?", answer:"extase de sainte th√©r√®se", hint:"Le Bernin" },
{ id:'r_colonna', name:'Piazza Colonna ‚Äì Colonne de Marc Aur√®le', lat:41.9017, lng:12.4792, radius:20, question:"√Ä quel empereur est d√©di√©e la colonne ?", answer:"marc aur√®le", hint:"Bas-reliefs en spirale" },
{ id:'r_montecitorio', name:'Piazza Montecitorio ‚Äì Ob√©lisque', lat:41.9027, lng:12.4799, radius:20, question:"Quel type de monument s‚Äôy dresse ?", answer:"ob√©lisque", hint:"Granite" },
{ id:'r_piazza_rotonda', name:'Piazza della Rotonda', lat:41.8980, lng:12.4768, radius:20, question:"Quel √©difice monumental borde la place ?", answer:"panth√©on", hint:"Grand oculus" },
{ id:'r_campo_fiori', name:'Campo de‚Äô Fiori', lat:41.8956, lng:12.4722, radius:20, question:"Qui est la statue au centre ?", answer:"giordano bruno", hint:"Philosophe" },
{ id:'r_santagnese', name:'Sant‚ÄôAgnese in Agone', lat:41.8996, lng:12.4733, radius:20, question:"Sur quelle place baroque se trouve l‚Äô√©glise ?", answer:"piazza navona", hint:"Trois fontaines" },
{ id:'r_minerva', name:'Santa Maria sopra Minerva', lat:41.8983, lng:12.4777, radius:20, question:"Quel animal porte l‚Äôob√©lisque sur le parvis ?", answer:"√©l√©phant", hint:"Statue du Bernin" },
{ id:'r_sant_ignazio', name:'Sant‚ÄôIgnazio di Loyola', lat:41.8991, lng:12.4806, radius:20, question:"Quel effet optique au plafond simule une coupole ?", answer:"trompe-l'≈ìil", hint:"Illusion peinte" },
{ id:'r_piazza_pietra', name:'Piazza di Pietra ‚Äì Temple d‚ÄôHadrien', lat:41.9011, lng:12.4790, radius:20, question:"Combien de colonnes visibles restent align√©es ?", answer:"11", hint:"Compte les colonnes" },
{ id:'r_terme_caracalla', name:'Thermes de Caracalla', lat:41.8790, lng:12.4932, radius:20, question:"Quel type d‚Äô√©difice antique ?", answer:"bains", hint:"Thermes" },
{ id:'r_porta_san_sebastiano', name:'Porta San Sebastiano', lat:41.8736, lng:12.5018, radius:20, question:"Quelle voie antique commence ici ?", answer:"via appia", hint:"Reine des routes" },
{ id:'r_catacombe_callisto', name:'Catacombes de Saint-Callixte', lat:41.8474, lng:12.5210, radius:20, question:"Que trouve-t-on sous terre ici ?", answer:"s√©pultures", hint:"Cimeti√®res chr√©tiens" },
{ id:'r_catacombe_sebastiano', name:'Catacombes de Saint-S√©bastien', lat:41.8463, lng:12.5135, radius:20, question:"Quel martyr est honor√© ?", answer:"saint s√©bastien", hint:"Fl√®ches" },
{ id:'r_san_paolo_fuori', name:'Basilique Saint-Paul-hors-les-Murs', lat:41.8587, lng:12.4768, radius:20, question:"Quel ap√¥tre y est v√©n√©r√© ?", answer:"paul", hint:"Compagnon de Pierre" },
{ id:'r_piramide_cestia', name:'Pyramide de Cestius', lat:41.8756, lng:12.4823, radius:20, question:"Quel peuple a inspir√© sa forme ?", answer:"√©gyptiens", hint:"Tombe triangulaire" },
{ id:'r_porta_san_paolo', name:'Porta San Paolo', lat:41.8749, lng:12.4829, radius:20, question:"Quel mus√©e ferroviaire est tout proche ?", answer:"mus√©e ostiense", hint:"Trains anciens" },
{ id:'r_gazometro', name:'Gazometro ‚Äì Ostiense', lat:41.8668, lng:12.4726, radius:20, question:"Quelle structure m√©tallique circulaire domine le quartier ?", answer:"gazom√®tre", hint:"Ancien r√©servoir" },
{ id:'r_monte_testaccio', name:'Monte Testaccio', lat:41.8729, lng:12.4752, radius:20, question:"De quoi est fait ce ¬´ mont ¬ª ?", answer:"amphores", hint:"Tessons empil√©s" },
{ id:'r_giardino_aranci', name:'Giardino degli Aranci', lat:41.8842, lng:12.4799, radius:20, question:"Quel parfum donne son nom au jardin ?", answer:"orangers", hint:"Agrumes" },
{ id:'r_buco_serratura', name:'Trou de la Serrure (Aventin)', lat:41.8870, lng:12.4776, radius:20, question:"√Ä travers le trou, quel d√¥me c√©l√®bre aper√ßoit-on ?", answer:"saint-pierre", hint:"Vue parfaite" },
{ id:'r_santa_sabina', name:'Basilique Santa Sabina', lat:41.8879, lng:12.4792, radius:20, question:"Quel bois antique composent ses portes c√©l√®bres ?", answer:"c√®dre", hint:"Panneaux sculpt√©s" },
{ id:'r_circo_maxentius', name:'Cirque de Maxence (Via Appia)', lat:41.8344, lng:12.5219, radius:20, question:"Quel empereur fit b√¢tir ce cirque ?", answer:"maxence", hint:"IVe si√®cle" },
{ id:'r_cecilia_metella', name:'Mausol√©e de C√©cilia Metella', lat:41.8397, lng:12.5115, radius:20, question:"Quelle forme architecturale principale ?", answer:"cylindre", hint:"Tombe circulaire" },
{ id:'r_fontana_rane', name:'Fontana delle Rane (Copped√®)', lat:41.9199, lng:12.4995, radius:20, question:"Quel animal orne la fontaine ?", answer:"grenouilles", hint:"Amphibiens" },
{ id:'r_san_luigi_francesi', name:'San Luigi dei Francesi', lat:41.8990, lng:12.4767, radius:20, question:"Quel peintre y a trois toiles de Saint Matthieu ?", answer:"caravage", hint:"Clair-obscur" },
{ id:'r_sant_agostino', name:'Sant‚ÄôAgostino', lat:41.9004, lng:12.4749, radius:20, question:"Quel peintre y a une ¬´ Madone des P√®lerins ¬ª ?", answer:"caravage", hint:"Pieds sales" },
{ id:'r_maria_pace', name:'Santa Maria della Pace', lat:41.9005, lng:12.4729, radius:20, question:"Quel architecte a con√ßu le petit clo√Ætre ?", answer:"bramante", hint:"Renaissance" },
{ id:'r_villa_medici', name:'Villa M√©dicis', lat:41.9090, lng:12.4851, radius:20, question:"Quel pays y a son acad√©mie d‚Äôart ?", answer:"france", hint:"Acad√©mie fran√ßaise" },
{ id:'r_palazzo_spada', name:'Palazzo Spada ‚Äì Perspective', lat:41.8947, lng:12.4728, radius:20, question:"Quel architecte r√©alisa la galerie en trompe-l‚Äô≈ìil ?", answer:"borromini", hint:"Perspective forc√©e" },
{ id:'r_san_clemente', name:'Basilique San Clemente', lat:41.8893, lng:12.4989, radius:20, question:"Combien de niveaux arch√©ologiques superpos√©s ?", answer:"3", hint:"Strates" },
{ id:'r_san_giovanni', name:'Archibasilique Saint-Jean de Latran', lat:41.8864, lng:12.5057, radius:20, question:"Quel rang porte cette basilique ?", answer:"archibasilique", hint:"La plus haute dignit√©" },
{ id:'r_scala_santa', name:'Scala Santa (Saintes Marches)', lat:41.8859, lng:12.5067, radius:20, question:"Que font certains p√®lerins sur ces marches ?", answer:"montent √† genoux", hint:"D√©votion" },
{ id:'r_santa_croce', name:'Santa Croce in Gerusalemme', lat:41.8869, lng:12.5141, radius:20, question:"Quel type de reliques y est conserv√© ?", answer:"de la croix", hint:"Passion" },
{ id:'r_santa_maria_maggiore', name:'Basilique Sainte-Marie-Majeure', lat:41.8979, lng:12.4989, radius:20, question:"Quel m√©tal pr√©cieux recouvre le plafond ?", answer:"or", hint:"Don d‚ÄôEspagne" },
{ id:'r_piazza_vittorio', name:'Piazza Vittorio ‚Äì Porta Magica', lat:41.8945, lng:12.5057, radius:20, question:"Quel adjectif qualifie la petite porte du parc ?", answer:"magique", hint:"Alchimie" },
{ id:'r_san_pietro_vincoli', name:'San Pietro in Vincoli', lat:41.8904, lng:12.4943, radius:20, question:"Quelle statue c√©l√®bre s‚Äôy trouve (proph√®te) ?", answer:"mo√Øse", hint:"Michel-Ange" },
{ id:'r_santa_prassede', name:'Santa Prassede', lat:41.8972, lng:12.4984, radius:20, question:"Quelle chapelle est c√©l√®bre pour ses mosa√Øques byzantines ?", answer:"san zenone", hint:"Bleus profonds" },
{ id:'r_aracoeli', name:'Santa Maria in Aracoeli', lat:41.8936, lng:12.4829, radius:20, question:"Que montes-tu pour y acc√©der ?", answer:"un escalier", hint:"Beaucoup de marches" },
{ id:'r_santandrea_valle', name:'Sant‚ÄôAndrea della Valle', lat:41.8960, lng:12.4760, radius:20, question:"Quelle ≈ìuvre lyrique d√©bute ici (Puccini) ?", answer:"tosca", hint:"Acte I" },
{ id:'r_sant_ivo', name:'Sant‚ÄôIvo alla Sapienza', lat:41.8980, lng:12.4766, radius:20, question:"Quelle forme a la fl√®che du d√¥me ?", answer:"spirale", hint:"Cochlea" },
{ id:'r_fontana_tartarughe', name:'Fontana delle Tartarughe', lat:41.8947, lng:12.4751, radius:20, question:"Quel animal orne la fontaine ?", answer:"tortues", hint:"Bronze" },
{ id:'r_piazza_colonna_poste', name:'Piazza Colonna ‚Äì Palais des Postes', lat:41.9018, lng:12.4796, radius:20, question:"Quelle colonne antique voisine la place ?", answer:"marc aur√®le", hint:"Colonne triomphale" },
{ id:'r_via_condotti', name:'Via dei Condotti', lat:41.9052, lng:12.4806, radius:20, question:"Quel type de boutiques c√©l√®bre la rue ?", answer:"luxe", hint:"Grandes marques" },
{ id:'r_via_del_corso', name:'Via del Corso (milieu)', lat:41.9024, lng:12.4798, radius:20, question:"Entre quelles places principales s‚Äô√©tend la rue ?", answer:"venezia et popolo", hint:"Du centre au nord" },
{ id:'r_termine', name:'Gare Termini ‚Äì Fa√ßade', lat:41.9010, lng:12.5014, radius:20, question:"Quel moyen de transport principal ici ?", answer:"train", hint:"Gare" },
{ id:'r_quartiere_coppede', name:'Quartier Copped√® ‚Äì Entr√©e', lat:41.9189, lng:12.4992, radius:20, question:"Quel style √©clectique le caract√©rise ?", answer:"art nouveau", hint:"Liberty" },
{ id:'r_piazza_bologna_popolo', name:'Piazza del Popolo ‚Äì √âglises jumelles', lat:41.9102, lng:12.4762, radius:20, question:"Combien d‚Äô√©glises ¬´ jumelles ¬ª bordent le sud de la place ?", answer:"2", hint:"Sym√©trie" },
{ id:'r_cavour', name:'Piazza Cavour ‚Äì Palais de Justice', lat:41.9059, lng:12.4682, radius:20, question:"Quel pouvoir s‚Äôexerce dans ce palais ?", answer:"justice", hint:"Cour de cassation" },
{ id:'r_villa_celib', name:'Piazza di Siena (Villa Borghese)', lat:41.9156, lng:12.4903, radius:20, question:"Quel type d‚Äô√©v√©nement √©questre c√©l√®bre s‚Äôy tient ?", answer:"concours hippique", hint:"Sauts d‚Äôobstacles" },
{ id:'r_marcello_portico', name:'Porta Portese (march√©)', lat:41.8779, lng:12.4675, radius:20, question:"Quel jour le march√© aux puces bat son plein ?", answer:"dimanche", hint:"Week-end" },
{ id:'r_porta_maggiore', name:'Porta Maggiore', lat:41.8897, lng:12.5150, radius:20, question:"Quelle structure antique traverse la porte ?", answer:"aqueduc", hint:"Eau" },
{ id:'r_santa_costanza', name:'Mausol√©e de Sainte-Constance', lat:41.9266, lng:12.5208, radius:20, question:"Quel plan a l‚Äô√©difice ?", answer:"circular", hint:"Rotonde" },
{ id:'r_sant_croce_ger', name:'San Lorenzo fuori le mura', lat:41.9021, lng:12.5247, radius:20, question:"Quel saint y est honor√© (nom) ?", answer:"laurent", hint:"Grille" },
{ id:'r_eur_quadrato', name:'Palazzo della Civilt√† Italiana (EUR)', lat:41.8359, lng:12.4653, radius:20, question:"Quel surnom porte le b√¢timent ?", answer:"colis√©e carr√©", hint:"Arches r√©guli√®res" },
{ id:'r_eur_laghetto', name:'Lac de l‚ÄôEUR ‚Äì Pont', lat:41.8308, lng:12.4678, radius:20, question:"Quel plan d‚Äôeau orne le quartier ?", answer:"lac", hint:"Plan d‚Äôeau" },
{ id:'r_forum_trajan', name:'Forum de Trajan', lat:41.8958, lng:12.4846, radius:20, question:"Quelle colonne triomphale s‚Äôy dresse ?", answer:"colonne trajane", hint:"Bas-reliefs h√©lico√Ødaux" },
{ id:'r_markets_trajan', name:'March√©s de Trajan', lat:41.8952, lng:12.4857, radius:20, question:"Quel type de b√¢timent antique √©tait-ce ?", answer:"march√©", hint:"Commerces superpos√©s" },
{ id:'r_forum_caesar', name:'Forum de C√©sar', lat:41.8950, lng:12.4867, radius:20, question:"Quel dictateur lui a donn√© son nom ?", answer:"c√©sar", hint:"Jules" },
{ id:'r_forum_augustus', name:'Forum d‚ÄôAuguste', lat:41.8959, lng:12.4875, radius:20, question:"Quel empereur honore ce forum ?", answer:"auguste", hint:"Premier empereur" },
{ id:'r_venere_roma', name:'Temple de V√©nus et de Rome', lat:41.8908, lng:12.4929, radius:20, question:"√Ä quelles deux divinit√©s est d√©di√© le temple ?", answer:"v√©nus et rome", hint:"Face au Colis√©e" },
{ id:'r_domus_aurea', name:'Domus Aurea (N√©ron)', lat:41.8917, lng:12.4957, radius:20, question:"Quel empereur fit b√¢tir ce palais ?", answer:"n√©ron", hint:"Apr√®s l‚Äôincendie" }
  
    ];

    const ROOMS = [
  { id:'salle1', name:'Salle 1 ‚Äì Chapelle Sixtine', works:[
    { id:'oeuvre1', title:"Michel-Ange ‚Äì Cr√©ation d‚ÄôAdam", question:"Quel geste c√©l√®bre relie Dieu et Adam ?", answer:"doigt", hint:"Presque en contact" },
    { id:'oeuvre2', title:"Michel-Ange ‚Äì Jugement dernier", question:"Quelle figure centrale juge les √¢mes ?", answer:"christ", hint:"Au centre du mur" }
  ]},
  { id:'salle2', name:'Salle 2 ‚Äì Stanze de Rapha√´l', works:[
    { id:'oeuvre3', title:"Rapha√´l ‚Äì √âcole d‚ÄôAth√®nes", question:"Quels deux philosophes dominent au centre ?", answer:"platon et aristote", hint:"Un pointe le ciel" },
    { id:'oeuvre4', title:"Rapha√´l ‚Äì Dispute du Saint-Sacrement", question:"Quel objet dor√© est au centre de la composition ?", answer:"hostie", hint:"Monstrance" }
  ]},
  { id:'salle3', name:'Salle 3 ‚Äì Galerie des cartes', works:[
    { id:'oeuvre5', title:"Carte de l‚ÄôItalie du Nord", question:"Quel lac est visible au nord de Milan ?", answer:"lac de come", hint:"Forme allong√©e" },
    { id:'oeuvre6', title:"Carte de la Sicile", question:"Quel volcan y est repr√©sent√© en activit√© ?", answer:"etna", hint:"Feu et fum√©e" }
  ]},
  { id:'salle4', name:'Salle 4 ‚Äì Galerie des tapisseries', works:[
    { id:'oeuvre7', title:"Tapisserie de la R√©surrection du Christ", question:"Quel d√©tail brille au-dessus du tombeau ?", answer:"lumi√®re", hint:"Symbole divin" },
    { id:'oeuvre8', title:"Tapisserie de la C√®ne", question:"Combien d‚Äôap√¥tres entourent J√©sus ?", answer:"12", hint:"Classique" }
  ]},
  { id:'salle5', name:'Salle 5 ‚Äì Pinacoth√®que', works:[
    { id:'oeuvre9', title:"Rapha√´l ‚Äì La Transfiguration", question:"Quel d√©tail appara√Æt en haut √† gauche ?", answer:"montagne", hint:"Paysage" },
    { id:'oeuvre10', title:"L√©onard de Vinci ‚Äì Saint J√©r√¥me", question:"Quel animal est repr√©sent√© √† ses pieds ?", answer:"lion", hint:"Compagnon fid√®le" }
  ]},
  { id:'salle6', name:'Salle 6 ‚Äì Mus√©e Pio-Clementino', works:[
    { id:'oeuvre11', title:"Laocoon et ses fils", question:"Quels animaux mythiques attaquent les personnages ?", answer:"serpents", hint:"Deux enroul√©s" },
    { id:'oeuvre12', title:"Apollon du Belv√©d√®re", question:"Quelle arme manie-t-il ?", answer:"arc", hint:"Chasseur" }
  ]},
  { id:'salle7', name:'Salle 7 ‚Äì Mus√©e √âgyptien', works:[
    { id:'oeuvre13', title:"Sphinx de granit", question:"Quel animal poss√®de-t-il pour corps ?", answer:"lion", hint:"Force et myst√®re" },
    { id:'oeuvre14', title:"Momie d‚Äôun pr√™tre", question:"Quel mat√©riau enveloppe la momie ?", answer:"lin", hint:"Bandelettes" }
  ]},
  { id:'salle8', name:'Salle 8 ‚Äì Mus√©e √âtrusque', works:[
    { id:'oeuvre15', title:"Chim√®re d‚ÄôArezzo", question:"Quel animal forme sa t√™te principale ?", answer:"lion", hint:"Triple cr√©ature" },
    { id:'oeuvre16', title:"Urne fun√©raire peinte", question:"Quel type de sc√®ne y est repr√©sent√© ?", answer:"banquet", hint:"F√™te fun√©raire" }
  ]},
  { id:'salle9', name:'Salle 9 ‚Äì Collection d‚Äôart moderne', works:[
    { id:'oeuvre17', title:"Matisse ‚Äì Croix bleue", question:"Quel instrument de d√©coupe a-t-il utilis√© ?", answer:"ciseaux", hint:"Papiers d√©coup√©s" },
    { id:'oeuvre18', title:"Chagall ‚Äì Crucifixion blanche", question:"Quelle couleur domine la sc√®ne ?", answer:"blanc", hint:"Titre indicatif" }
  ]},
  { id:'salle10', name:'Salle 10 ‚Äì Cour du Belv√©d√®re', works:[
    { id:'oeuvre19', title:"Torse du Belv√©d√®re", question:"Quelle partie du corps manque ?", answer:"t√™te", hint:"Et bras" },
    { id:'oeuvre20', title:"Hercule Farn√®se", question:"Quel objet tient-il derri√®re le dos ?", answer:"pomme", hint:"Des Hesp√©rides" }
  ]},
  { id:'salle11', name:'Salle 11 ‚Äì Galerie des cand√©labres', works:[
    { id:'oeuvre21', title:"Statue de Diane chasseresse", question:"Quel animal l‚Äôaccompagne ?", answer:"cerf", hint:"Animal des for√™ts" },
    { id:'oeuvre22', title:"Buste d‚ÄôAuguste", question:"Quel accessoire de t√™te porte-t-il ?", answer:"couronne de laurier", hint:"Symbole imp√©rial" }
  ]},
  { id:'salle12', name:'Salle 12 ‚Äì Appartement Borgia', works:[
    { id:'oeuvre23', title:"Pinturicchio ‚Äì Les Arts lib√©raux", question:"Combien de figures f√©minines sont repr√©sent√©es ?", answer:"7", hint:"Comme les arts" },
    { id:'oeuvre24', title:"Pinturicchio ‚Äì La R√©surrection", question:"Quel animal est couch√© pr√®s du Christ ressuscit√© ?", answer:"soldat", hint:"Garde endormi" }
  ]},
  { id:'salle13', name:'Salle 13 ‚Äì Cour int√©rieure finale', works:[
    { id:'oeuvre25', title:"Sph√®re dor√©e de Pomodoro", question:"Quel mat√©riau principal compose la sph√®re ?", answer:"bronze", hint:"M√©tal poli" }
  ]}
];

    // Partie 3 ‚Äî Point A (objectif final) + vid√©o
    const FINALE = { lat:45.7473294564984,  lng:4.8932271161288075 , radius:10, youtube:"https://youtube.com/shorts/GxVgj9djLY4?feature=shareQ" };
    // Partie 3 ‚Äî Point B (d√©clencheur d'affichage de la carte P3 √† 1500 m)
    const P3_B = { lat:45.75054211670309,   lng:4.897894951199942, radius:500 };

    const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const TILE_ATTRIB = '&copy; contributeurs <a href="https://www.openstreetmap.org/">OpenStreetMap</a>';
    const START_VIEW = [41.8986, 12.4769];
    const START_ZOOM = 15;
    const GEO_OPTIONS = { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 };

    // ========= 2) UTIL ========
	// Helpers d'UI (drawer & panneau bas)
	function setDrawer(open){
		const app = document.getElementById('app');
		if(open){ app.classList.add('with-drawer'); app.classList.remove('without-drawer'); }
		else    { app.classList.add('without-drawer'); app.classList.remove('with-drawer'); }
		// Recalibrer les cartes visibles
		setTimeout(()=>{ try{ map && map.invalidateSize(); }catch(e){} try{ p3Map && p3Map.invalidateSize && p3Map.invalidateSize(); }catch(e){} }, 150);
	}
	function isPanelCollapsed(){ return document.querySelector('.panel')?.classList.contains('collapsed'); }
	function setPanelCollapsed(collapsed){
		const panel = document.querySelector('.panel');
		if(!panel) return;
		if(collapsed) panel.classList.add('collapsed'); else panel.classList.remove('collapsed');
	}

    const normalize = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase();
    const storageKey = (k)=> `rome-game-${k}`;
    const save = (k,v)=> localStorage.setItem(storageKey(k), JSON.stringify(v));
    const load = (k,def)=> { try{ return JSON.parse(localStorage.getItem(storageKey(k))) ?? def; } catch{ return def; } };

    // States persist√©s
    const progress   = load('progress', {});       // Partie 1: { id: 'locked'|'unlocked'|'started'|'done' }
    const p1Override = load('p1Override', false);  // gage ‚Üí 100%
    const p2State    = load('p2State', {});        // Partie 2: { salleId: { oeuvreId: 'done' } }
    const p2Override = load('p2Override', false);
    // Nouvelles persistance des r√©ponses valid√©es
    const p1Answers = load('p1Answers', {});   // { placeId: 'r√©ponse' }
    const p2Answers = load('p2Answers', {});   // { 'roomId.workId': 'r√©ponse' }
    const p3VictoryState = false;

    // ========= 3) PARTIE 1 ‚Äî CARTE ========
    const map = L.map('map');
    L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(map);
    map.setView(START_VIEW, START_ZOOM);
	// Mobile: menu ferm√© et panneau bas repli√© par d√©faut
	const preferCollapsed = window.innerWidth < 900;
	setDrawer(!preferCollapsed);          // sur mobile => menu ferm√©
	setPanelCollapsed(preferCollapsed);   // sur mobile => panneau bas repli√©

	// Bouton menu (‚ò∞) : ouvre/ferme le panneau gauche
	const btnDrawer = document.getElementById('btnDrawer');
	btnDrawer?.addEventListener('click', ()=>{
		const app = document.getElementById('app');
		const open = !app.classList.contains('with-drawer');
		setDrawer(open);
	});

	// Bouton panneau bas (‚¨ÜÔ∏è / ‚¨áÔ∏è) : affiche/masque la zone lieux+gages+cl√©
	const btnPanelToggle = document.getElementById('btnPanelToggle');
	btnPanelToggle?.addEventListener('click', ()=>{
		const collapsed = isPanelCollapsed();
		setPanelCollapsed(!collapsed);
		btnPanelToggle.textContent = collapsed ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
	});

    map.on('popupopen', (e) => {
      const el = e.popup && e.popup.getElement ? e.popup.getElement() : (e.popup && e.popup._container);
      if (el) { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); }
    });

    const IconLocked = new L.DivIcon({ className:'icon-locked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #718096;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîí</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconUnlocked = new L.DivIcon({ className:'icon-unlocked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #38a169;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîì</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconDone = new L.DivIcon({ className:'icon-done', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #2b6cb0;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">‚úÖ</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });

    const placesLayer = L.layerGroup().addTo(map);
    let userMarker = null, accuracyCircle = null;

    const placesList = document.getElementById('placesList');

    function renderList(){
      placesList.innerHTML='';
      PLACES.forEach(p=>{
        const st = progress[p.id] || 'locked';
        const div = document.createElement('div');
        div.className = `place-row ${st}`;
        const answerTag = (st==='done' && p1Answers[p.id]) ? `<div class="hint">R√©ponse : <em>${p1Answers[p.id]}</em></div>` : `<div class="hint">rayon ${p.radius} m</div>`;
        div.innerHTML = `<div><strong>${p.name}</strong>${answerTag}</div><div class="right">${st==='done'?'‚úÖ': (st==='unlocked'||st==='started')?'üîì':'üîí'}</div>`;
        div.onclick = ()=> map.setView([p.lat,p.lng], 18, {animate:true});
        placesList.appendChild(div);
      });
      updateP1Progress();
    }

    function placePopupContent(p){
      const st = progress[p.id] || 'locked';
      if(st==='locked'){
        return `<div class="popup"><h3>${p.name}</h3><p>üîí Tu es trop loin. Approche √† <strong>${p.radius} m</strong>.</p></div>`;
      }
      if(st==='done'){
        const ans = p1Answers[p.id] ? `<p><strong>R√©ponse :</strong> ${p1Answers[p.id]}</p>` : '';
        return `<div class="popup"><h3>${p.name}</h3><p>‚úÖ D√©j√† valid√© !</p>${ans}</div>`;
      }
      if(st==='unlocked'){
        return `<div class="popup"><h3>${p.name}</h3><p>Tu es √† port√©e. Pr√™t(e)?</p><button onclick="event.stopPropagation(); window.__startChallenge('${p.id}'); return false;">Commencer le d√©fi</button></div>`;
      }
      // started
      return `<div class="popup"><h3>${p.name}</h3><p>${p.question}</p><input id="ans-${p.id}" type="text" placeholder="R√©ponse" autofocus onclick="event.stopPropagation();" onfocus="event.stopPropagation();" /><button onclick="event.stopPropagation(); window.__checkAnswer('${p.id}'); return false;">Valider</button><p class="hint">Indice : ${p.hint||'‚Äî'}</p></div>`;
    }

    const markersById = {}, lastPopupState = {};

    function addPlaceMarker(p){
      const st = progress[p.id] || 'locked';
      const m = L.marker([p.lat,p.lng], { icon: st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked });
      m.bindPopup(placePopupContent(p));
      m.on('popupopen', ()=> lastPopupState[p.id] = progress[p.id] || 'locked');
      m.addTo(placesLayer);
      markersById[p.id]=m;
    }
    function refreshMarker(p){
      const m = markersById[p.id];
      const st = progress[p.id] || 'locked';
      m.setIcon(st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked);
      m.setPopupContent(placePopupContent(p));
    }

    PLACES.forEach(addPlaceMarker);
    function renderMarkers(){ PLACES.forEach(refreshMarker); }

    window.__startChallenge = function(id){
      const p=PLACES.find(x=>x.id===id); if(!p) return;
      progress[id]='started'; save('progress',progress);
      refreshMarker(p); markersById[id].openPopup(); lastPopupState[id]='started';
      updateP1Progress();
    };

    window.__checkAnswer = function(id){
      const p=PLACES.find(x=>x.id===id); const input=document.getElementById(`ans-${id}`);
      if(!p||!input) return;
      const userVal = input.value;
      const ok = normalize(userVal)===normalize(p.answer);
      const gpsText=document.getElementById('gpsText');
      if(ok){
        progress[id]='done';
        p1Answers[id] = userVal; // conserve la r√©ponse telle que saisie
        save('progress',progress); save('p1Answers', p1Answers);
        refreshMarker(p); renderList();
        gpsText.textContent=`Bravo ! √âtape ¬´ ${p.name} ¬ª valid√©e.`; lastPopupState[id]='done';
      } else {
        gpsText.textContent='Mauvaise r√©ponse, essaie encore.'; input.focus(); input.select&&input.select();
      }
    };

    function updateP1Progress(){
      const total = PLACES.length;
      const done  = PLACES.filter(p=>progress[p.id]==='done').length;
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p1Override', false);
      if(override) pct=100;
      document.getElementById('p1Pct').textContent = pct+'%';
      document.getElementById('p1Bar').style.width = pct+'%';
      const key = document.getElementById('p1Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 4) PARTIE 2 ‚Äî ROOMS ========
    const roomsContainer = document.getElementById('rooms');
    function renderRooms(){
      roomsContainer.innerHTML='';
      ROOMS.forEach(room=>{
        const card=document.createElement('div'); card.className='room';
        card.innerHTML = `<h3>${room.name}</h3>`;
        const list=document.createElement('div');
        const state = p2State[room.id] || {};
        room.works.forEach(w=>{
          const done = state[w.id]==='done';
          const key = `${room.id}.${w.id}`;
          const savedVal = p2Answers[key] || '';
          const row=document.createElement('div'); row.className='work';
          row.innerHTML = `<div class=\"state\">${done?'‚úÖ':'üïµÔ∏è'}</div>
            <div class=\"title\" style=\"flex:1\"><strong>${w.title}</strong><div class=\"hint\">${w.question}</div></div>
            <input type=\"text\" id=\"w-${room.id}-${w.id}\" placeholder=\"R√©ponse\" ${done?'disabled':''} value=\"${done ? savedVal.replace(/\"/g,'\\"') : ''}\"/>
            <button data-room=\"${room.id}\" data-work=\"${w.id}\">${done?'R√©pondu':'Valider'}</button>`;
          list.appendChild(row);
        });
        card.appendChild(list);
        roomsContainer.appendChild(card);
      });
      roomsContainer.querySelectorAll('button[data-room]').forEach(btn=>{
        btn.onclick=()=>{
          const roomId=btn.getAttribute('data-room'); const workId=btn.getAttribute('data-work');
          const room=ROOMS.find(r=>r.id===roomId); const work=room.works.find(x=>x.id===workId);
          const input=document.getElementById(`w-${roomId}-${workId}`); if(!input) return;
          const ok=normalize(input.value)===normalize(work.answer);
          if(ok){
            // conserve la valeur telle que saisie
            const key = `${roomId}.${workId}`;
            p2State[roomId]=p2State[roomId]||{}; p2State[roomId][workId]='done';
            p2Answers[key] = input.value;
            save('p2State',p2State); save('p2Answers', p2Answers);
            renderRooms(); updateP2Progress();
          }else{ input.focus(); input.select&&input.select(); }
        };
      });
    }

    function updateP2Progress(){
      const total = ROOMS.reduce((s,r)=>s+r.works.length,0);
      const done  = ROOMS.reduce((s,r)=> s + (Object.values(p2State[r.id]||{}).filter(v=>v==='done').length), 0);
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p2Override', false);
      if(override) pct=100;
      document.getElementById('p2Pct').textContent = pct+'%';
      document.getElementById('p2Bar').style.width = pct+'%';
      const key = document.getElementById('p2Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 5) PARTIE 3 ‚Äî CL√âS + GEOFENCE + CARTE POINT B & CHAUD/FROID ========
    const p3Status=document.getElementById('p3Status');
    const p3Action=document.getElementById('p3Action');
    const p3Pct=document.getElementById('p3Pct');
    const p3Bar=document.getElementById('p3Bar');
    const victoryLink=document.getElementById('victoryLink'); victoryLink.href = FINALE.youtube;

    // Carte de la Partie 3
    const p3MapWrap = document.getElementById('p3MapWrap');
    let p3Map=null, p3UserMarker=null, p3BCircle=null, p3ACircle=null, p3AMarker=null;

    // D√©grad√© couleur du marqueur utilisateur selon distance au Point A
    function lerp(a,b,t){ return a + (b-a)*t; }
    function heatColor(distance){
      // Couleurs "froid -> chaud" en passant par vert/jaune/orange (pas de violet)
      // t = 0 (loin) ‚Üí bleu | t = 1 (tr√®s proche) ‚Üí rouge
      const MAX = 1500; // distance √† partir de laquelle on consid√®re "tr√®s loin"
      const clamp = (v,min,max)=> Math.min(max, Math.max(min, v));
      // Accentuer la sensibilit√© proche du but (courbe gamma)
      let t = 1 - clamp(distance / MAX, 0, 1);
      t = Math.pow(t, 0.7);
      const stops = [
        { t: 0.00, c: [30, 58, 138] },   // bleu
        { t: 0.25, c: [0, 170, 0] },     // vert
        { t: 0.50, c: [255, 215, 0] },   // jaune
        { t: 0.75, c: [255, 140, 0] },   // orange
        { t: 1.00, c: [220, 38, 38] }    // rouge
      ];
      function lerp(a,b,u){ return a + (b-a)*u; }
      function mix(c1,c2,u){ return [
        Math.round(lerp(c1[0], c2[0], u)),
        Math.round(lerp(c1[1], c2[1], u)),
        Math.round(lerp(c1[2], c2[2], u))
      ]; }
      // Trouver le segment correspondant
      for(let i=0;i<stops.length-1;i++){
        const a=stops[i], b=stops[i+1];
        if(t>=a.t && t<=b.t){
          const u = (t - a.t) / (b.t - a.t);
          const c = mix(a.c, b.c, u);
          return `rgb(${c[0]},${c[1]},${c[2]})`;
        }
      }
      const last = stops[stops.length-1].c; // fallback
      return `rgb(${last[0]},${last[1]},${last[2]})`;
    }
    function userDivIcon(color){
      return new L.DivIcon({
        className:'p3-user',
        html:`<div style="width:22px;height:22px;border:2px solid #fff;background:${color};border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.25)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    function updateP3FromKeys(){
      const k1=!document.getElementById('p1Key').hasAttribute('disabled');
      const k2=!document.getElementById('p2Key').hasAttribute('disabled');
      const pct=(k1?50:0)+(k2?50:0);
      p3Pct.textContent=pct+'%'; p3Bar.style.width=pct+'%';
      if(k1&&k2){ p3Status.textContent='‚úÖ Cl√©s r√©unies ! Va au point final (10 m).'; p3Action.style.display='block'; }
      else { p3Status.innerHTML='üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.'; p3Action.style.display='none'; }
    }

    // ========= 6) G√âOLOCALISATION COMMUNE ========
    const gpsDot=document.getElementById('gpsDot');
    const gpsText=document.getElementById('gpsText');
    const accText=document.getElementById('accText');
    let watchId=null;
    function setStatus(kind,text,acc){ gpsDot.className='dot '+(kind||'err'); gpsText.textContent=text||''; accText.textContent=acc?`¬± ${Math.round(acc)} m`:'‚Äî'; }
    function ensureLocate(){ if(!('geolocation' in navigator)){ setStatus('err','G√©olocalisation non support√©e'); return; } if(watchId!==null) return; setStatus('warn','Demande de GPS‚Ä¶'); watchId=navigator.geolocation.watchPosition(onPos,onGeoError,GEO_OPTIONS); }
    function onGeoError(err){ setStatus('err',err.message||'Erreur de g√©olocalisation'); }

    const finaleCircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#2b6cb0', weight:1, fillOpacity:0.05 });

    function onPos(pos){
      const { latitude, longitude, accuracy } = pos.coords; const here=[latitude,longitude];
      // Marqueur utilisateur (Partie 1)
      if(!userMarker){ userMarker=L.marker(here,{title:'Vous'}).addTo(map); } else { userMarker.setLatLng(here); }
      if(!accuracyCircle){ accuracyCircle=L.circle(here,{radius:accuracy,weight:1,fillOpacity:0.1}).addTo(map); } else { accuracyCircle.setLatLng(here).setRadius(accuracy); }
      setStatus('ok','GPS actif',accuracy);

      // D√©verrouillage P1
      PLACES.forEach(p=>{
        const prev=progress[p.id]||'locked';
        const d=map.distance(here,[p.lat,p.lng]); const r=p.radius||20;
        if(d<=r && prev==='locked'){
          progress[p.id]='unlocked'; save('progress',progress);
          refreshMarker(p); renderList(); markersById[p.id].openPopup(); lastPopupState[p.id]='unlocked';
        }
        const curr=progress[p.id]||'locked'; const m=markersById[p.id];
        if(m.isPopupOpen()){
          if(curr==='locked'){
            m.setPopupContent(`<div class="popup"><h3>${p.name}</h3><p>üîí Tu es √† <strong>${Math.round(d)} m</strong>. Approche √† moins de <strong>${r} m</strong>.</p></div>`);
            lastPopupState[p.id]='locked';
          } else if(lastPopupState[p.id]!==curr){ m.setPopupContent(placePopupContent(p)); lastPopupState[p.id]=curr; }
        }
      });

      // Partie 3 : Carte conditionnelle autour de B + couleur ‚Äúchaud/froid‚Äù vers A
      const keysOK = !document.getElementById('p1Key').hasAttribute('disabled') && !document.getElementById('p2Key').hasAttribute('disabled');
      if(keysOK){
        const dB = map.distance(here, [P3_B.lat, P3_B.lng]);
        if(dB <= (P3_B.radius||1500)){
          // Afficher/initialiser carte P3
          p3MapWrap.style.display='block';
          if(!p3Map){
            p3Map = L.map('mapP3');
            L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(p3Map);
            p3Map.setView([P3_B.lat, P3_B.lng], 15);
            p3BCircle = L.circle([P3_B.lat, P3_B.lng], { radius: P3_B.radius, color:'#2b6cb0', weight:1, fillOpacity:0.03 }).addTo(p3Map);
            // p3ACircle : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
            // p3AMarker : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
          }
          // Mettre √† jour marqueur utilisateur P3 + couleur
          const dA = map.distance(here, [FINALE.lat, FINALE.lng]);
          const color = heatColor(dA);
          if(!p3UserMarker){ p3UserMarker = L.marker(here, { icon: userDivIcon(color) }).addTo(p3Map); }
          else { p3UserMarker.setLatLng(here); p3UserMarker.setIcon(userDivIcon(color)); }
          // Afficher/masquer le Point A uniquement dans un rayon de 10 m
          if(dA <= (FINALE.radius||10)){
            if(!p3AMarker){ p3AMarker = L.marker([FINALE.lat, FINALE.lng], { title:'Point A (objectif)' }).addTo(p3Map); }
            if(!p3ACircle){ p3ACircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#dc2626', weight:1, fillOpacity:0.06 }).addTo(p3Map); }
          } else {
            if(p3AMarker){ p3Map.removeLayer(p3AMarker); p3AMarker = null; }
            if(p3ACircle){ p3Map.removeLayer(p3ACircle); p3ACircle = null; }
          }
          // Victoire √† 10 m
          if(dA <= (FINALE.radius||10)){
            p3Status.textContent='üéØ Point final atteint !';
            const v = document.getElementById('p3Victory');
            if(v){ v.removeAttribute('disabled'); v.setAttribute('open',''); }
            p3Action.style.display='none';
          } else {
            const v = document.getElementById('p3Victory');
            if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); }
          }
        } else {
          // Hors zone de B ‚Üí cacher la carte P3
          p3MapWrap.style.display='none';
        }
      }
    }

    // ========= 7) NAV + BOUTONS ========
	function showScreen(id){
		document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
		const el = document.getElementById(id);
		if(el){ el.classList.add('visible'); }
		// Panneau bas uniquement en Partie 1
		const panel = document.querySelector('.panel');
		if(panel){ panel.style.display = (id==='part1') ? 'flex' : 'none'; }
		// Recalibrage des cartes visibles
		setTimeout(()=>{
			if(id==='part1') try{ map.invalidateSize(); }catch(e){}
			if(id==='part3') try{ p3Map && p3Map.invalidateSize(); }catch(e){}
		}, 120);
	}
	// Branchement des boutons du menu gauche
	[...document.querySelectorAll('#drawer .nav-item')].forEach(btn=>{
		btn.addEventListener('click', ()=>{
			const target = btn.getAttribute('data-target');
			showScreen(target);
			// Sur mobile: refermer le menu apr√®s le choix
			if(window.innerWidth < 900){ setDrawer(false); }
		});
	});

    document.getElementById('btnLocate').addEventListener('click', ()=>{ ensureLocate(); if(userMarker) map.setView(userMarker.getLatLng(), 17, {animate:true}); });
    document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('R√©initialiser toute la progression ?')) return; localStorage.clear(); location.reload(); });

    document.getElementById('p1GageDone').addEventListener('click', ()=>{ save('p1Override', true); updateP1Progress(); alert('Partie 1 valid√©e √† 100%'); });
    document.getElementById('p2GageDone').addEventListener('click', ()=>{ save('p2Override', true); updateP2Progress(); alert('Partie 2 valid√©e √† 100%'); });

    const drawerBtn=document.getElementById('btnDrawer');
    const navButtons=[...document.querySelectorAll('#drawer .nav-item')];
    drawerBtn.addEventListener('click', ()=>{ const d=document.getElementById('drawer'); d.style.display=(d.style.display==='none'?'block':'none'); });
    navButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const target=btn.getAttribute('data-target');
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
      document.getElementById(target).classList.add('visible');
      if(target==='part1'){ setTimeout(()=> map.invalidateSize(), 50); }
      if(target==='part3' && p3Map){ setTimeout(()=> p3Map.invalidateSize(), 50); }
    }));

    // ====== Contr√¥le d'acc√®s √† la Partie 2 (verrou si Partie 1 < 100%) ======
    const btnPart2 = document.querySelector('#drawer .nav-item[data-target="part2"]');
    function updatePart2Lock(){
      const allowed = !document.getElementById('p1Key').hasAttribute('disabled');
      if(allowed){
        btnPart2 && btnPart2.removeAttribute('disabled');
        if(btnPart2) btnPart2.title = 'üñºÔ∏è Partie 2 ‚Äî Vatican';
      } else {
        btnPart2 && btnPart2.setAttribute('disabled','');
        if(btnPart2) btnPart2.title = 'üîí Termine d\'abord la Partie 1 (100%)';
        // Si on est d√©j√† sur la Partie 2, on renvoie vers la Partie 1
        if(document.getElementById('part2').classList.contains('visible')){
          const btnP1 = document.querySelector('#drawer .nav-item[data-target="part1"]');
          btnP1 && btnP1.click();
        }
      }
    }
    // Bloque les clics sur le bouton Part 2 quand il est d√©sactiv√© (s√©curit√© suppl√©mentaire)
    document.addEventListener('click', (e)=>{
      const t = e.target.closest && e.target.closest('#drawer .nav-item[data-target="part2"]');
      if(t && t.hasAttribute('disabled')){ e.preventDefault(); e.stopPropagation(); alert('üîí Termine d\'abord la Partie 1 (100%) pour acc√©der √† la Partie 2.'); }
    });

    // ========= 8) RENDER INIT ========
    PLACES.forEach(addPlaceMarker); renderList();
    renderRooms(); updateP2Progress();
    updateP1Progress(); updateP3FromKeys(); updatePart2Lock();
    // Si la victoire a d√©j√† √©t√© atteinte dans une session pr√©c√©dente, d√©bloquer le dossier
    { const v=document.getElementById('p3Victory'); if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); } } 
    // iOS : demander d'appuyer sur üìç pour activer la g√©oloc
  </script>
</body>
</html>