<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jeu de piste Rome ‚Äì Carte interactive</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{--brand:#2b6cb0;--ok:#2f855a;--warn:#b7791f;--err:#c53030;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';}
    /* Mise en page avec menu */
    #app.with-drawer{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;min-height:100vh;}
    #drawer{grid-row:1/span 2;grid-column:1;background:#0f2747;color:#fff;padding:12px;display:block;}
    #drawer .drawer-header{font-weight:700;margin-bottom:10px;}
    #drawer .nav-item{width:100%;text-align:left;background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;cursor:pointer}
    #drawer .nav-item.active,#drawer .nav-item:hover{background:rgba(255,255,255,.12)}
    #drawer .nav-item[disabled]{opacity:.5; pointer-events:none; cursor:not-allowed;}
    header{grid-column:2;padding:10px 14px;background:var(--brand);color:#fff;position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .btn{border:0;background:rgba(255,255,255,.15);color:#fff;padding:8px 10px;border-radius:10px;font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#edf2f7;border-radius:999px;padding:4px 8px;font-size:12px;color:#1a202c}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* √âcrans */
    .screen{grid-column:2;display:none;position:relative}
    .screen.visible{display:block}
    /* Carte + panneaux */
    #map{height:calc(100vh - 70px)}
    #mapP3{height:60vh;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-top:10px}
    .panel{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:10px;z-index:1001}
    .card{flex:1;background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:10px}
    .status{font-size:12px;color:#333;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .status .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .status .ok{background:var(--ok)} .status .warn{background:var(--warn)} .status .err{background:var(--err)}
    .places{max-height:28vh;overflow:auto;margin-top:6px;font-size:14px}
    .place-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px}
    .place-row + .place-row{margin-top:6px}
    .place-row.locked{background:#f7fafc}
    .place-row.unlocked,.place-row.started{background:#f0fff4}
    .place-row.done{background:#edf2f7;text-decoration:line-through;color:#4a5568}
    .place-row .right{font-size:12px;color:#4a5568}
    .fab{position:fixed;right:16px;top:60px;z-index:1001}
    .fab button{border:0;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.2);border-radius:999px;padding:10px 12px}
    .leaflet-popup-content{margin:10px}
    .popup h3{margin:0 0 8px 0;font-size:16px}
    .popup p{margin:0 0 8px 0}
    .popup input{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e0;margin-bottom:8px}
    .popup button{width:100%;padding:10px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:600}
    .hint{font-size:12px;color:#4a5568}
    /* Progress bars */
    .progress{margin:8px 0 10px}
    .progress-row{font-size:14px;margin-bottom:6px}
    .bar{background:#e2e8f0;border-radius:999px;height:10px;overflow:hidden}
    .bar span{display:block;height:100%;background:var(--brand)}
    details.key[disabled] summary { color:#718096; }
    details.key[disabled] { pointer-events: none; opacity: 0.7; }
    details.key[disabled] .key-content { display: none; }
    /* Partie 2 : rooms/works */
    .rooms{padding:12px;display:grid;gap:12px}
    .room{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:10px}
    .room h3{margin-top:0}
    .work{display:flex;gap:8px;align-items:center;padding:6px 0}
    .work .state{width:22px;text-align:center}
    .work input[type=text]{flex:1;padding:8px;border-radius:8px;border:1px solid #cbd5e0}
    .work button{padding:8px 10px;border-radius:8px;border:0;background:var(--brand);color:#fff}
    .btn.small{padding:6px 10px;font-size:12px}
  </style>
</head>
<body>
  <div id="app" class="with-drawer">
    <aside id="drawer">
      <div class="drawer-header">Menu</div>
      <nav>
        <button class="nav-item active" data-target="part1">üó∫Ô∏è Partie 1 ‚Äî Rome</button>
        <button class="nav-item" data-target="part2">üñºÔ∏è Partie 2 ‚Äî Vatican</button>
        <button class="nav-item" data-target="part3">üå≥ Partie 3 ‚Äî Finale</button>
      </nav>
    </aside>

    <header>
      <button id="btnDrawer" class="btn" title="Ouvrir le menu">‚ò∞</button>
      <h1>Jeu de piste Rome</h1>
      <div class="legend">
        <span class="badge">üîí verrouill√©</span>
        <span class="badge">üîì √† port√©e</span>
        <span class="badge">‚úÖ valid√©</span>
      </div>
      <button id="btnReset" class="btn" title="R√©initialiser la progression">R√©initialiser</button>
    </header>

    <!-- ===== PARTIE 1 : CARTE & D√âFIS ROME ===== -->
    <section id="part1" class="screen visible">
      <div id="map"></div>

      <div class="fab">
        <button id="btnLocate" title="Me localiser">üìç</button>
      </div>

      <div class="panel">
        <div class="card">
          <div class="status" id="gpsStatus">
            <div><span class="dot err" id="gpsDot"></span><span id="gpsText">GPS inactif</span></div>
            <div><span id="accText">‚Äî</span></div>
          </div>
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 1</strong> ‚Äî <span id="p1Pct">0%</span></div>
            <div class="bar"><span id="p1Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p1Gages">
            <summary>üé≤ Gages (clique pour voir)</summary>
            <ul>
              <li><label><input type="radio" name="p1gage" value="0-20"> 0‚Äì20% : Paie le restaurant √† tout le groupe</label></li>
              <li><label><input type="radio" name="p1gage" value="20-40"> 20‚Äì40% : Paie ta tourn√©e</label></li>
              <li><label><input type="radio" name="p1gage" value="40-60"> 40‚Äì60% : Paie une glace √† l'organisateur</label></li>
              <li><label><input type="radio" name="p1gage" value="60-80"> 60‚Äì80% : Fais un discours en italien</label></li>
              <li><label><input type="radio" name="p1gage" value="80-99"> 80‚Äì99% : Selfie statue + pose gladiateur</label></li>
            </ul>
            <button id="p1GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 1 √† 100%</button>
          </details>
          <details id="p1Key" class="key" disabled>
            <summary>üìÅ Cl√© 1 (d√©bloqu√©e √† 100%)</summary>
            <div class="key-content"><strong>Blanc</strong></div>
          </details>
          <div class="places" id="placesList"></div>
        </div>
      </div>
    </section>

    <!-- ===== PARTIE 2 : MUS√âES DU VATICAN ===== -->
    <section id="part2" class="screen">
      <div class="vatican">
        <div class="card">
          <div class="progress">
            <div class="progress-row"><strong>Progression Partie 2</strong> ‚Äî <span id="p2Pct">0%</span></div>
            <div class="bar"><span id="p2Bar" style="width:0%"></span></div>
          </div>
          <details class="gages" id="p2Gages">
            <summary>üé≤ Gages (clique pour voir)</summary>
            <ul>
              <li><label><input type="radio" name="p2gage" value="0-20"> 0‚Äì20% : Paie le restaurant √† tout le groupe</label></li>
              <li><label><input type="radio" name="p2gage" value="20-40"> 20‚Äì40% : Paie ta tourn√©e</label></li>
              <li><label><input type="radio" name="p2gage" value="40-60"> 40‚Äì60% : Paie une glace √† l'organisateur</label></li>
              <li><label><input type="radio" name="p2gage" value="60-80"> 60‚Äì80% : D√©cris une ≈ìuvre en mimant</label></li>
              <li><label><input type="radio" name="p2gage" value="80-99"> 80‚Äì99% : Selfie couloir des cartes</label></li>
            </ul>
            <button id="p2GageDone" class="btn small">‚úÖ Gage effectu√© ‚Üí valider la Partie 2 √† 100%</button>
          </details>
          <details id="p2Key" class="key" disabled>
            <summary>üìÅ Cl√© 2 (d√©bloqu√©e √† 100%)</summary>
            <div class="key-content"><strong>Visage</strong></div>
          </details>
        </div>

        <div class="rooms" id="rooms"></div>
      </div>
    </section>

    <!-- ===== PARTIE 3 : FINALE ===== -->
    <section id="part3" class="screen">
      <div class="card">
        <h2>Finale ‚Äî Trouve le parc</h2>
        <p>Assemble les deux cl√©s pour r√©v√©ler le lieu final. Va au <strong>Point A</strong> (10 m) pour d√©bloquer la vid√©o de victoire.</p>
        <div id="p3Status" class="hint">üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.</div>
        <div class="progress">
          <div class="progress-row"><strong>Avanc√©e</strong> ‚Äî <span id="p3Pct">0%</span></div>
          <div class="bar"><span id="p3Bar" style="width:0%"></span></div>
        </div>
        <div id="p3Action" style="display:none">
          <p>Dirige-toi vers le point final (rayon 10 m). Quand tu y es, ouvre le dossier <strong>Victoire</strong>.</p>
        </div>
        <!-- Dossier Victoire (d√©bloqu√© uniquement quand le Point A est atteint) -->
        <details id="p3Victory" class="key" disabled>
          <summary>üìÅ Victoire</summary>
          <div class="key-content"><a id="victoryLink" href="#" target="_blank" class="btn">üéâ Voir la vid√©o</a></div>
        </details>
        <!-- Carte de la Partie 3 (affich√©e seulement si ‚â§ 1500 m de B et cl√©s OK) -->
        <div id="p3MapWrap" style="display:none">
          <div id="mapP3"></div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ========= 1) CONFIG =========
    const PLACES = [
      { id:'colisee', name:'Colis√©e', lat:41.8902, lng:12.4922, radius:20, question:"Au Colis√©e, notre 'gladiateur' du groupe avait quel surnom ?", answer:"le buffle", hint:"Surnom cri√© pendant le match de 2018‚Ä¶" },
      { id:'trevi', name:'Fontaine de Tr√©vi', lat:41.9009, lng:12.4833, radius:20, question:"Quel v≈ìu absurde avons-nous fait ce soir-l√† ? (un mot)", answer:"licorne", hint:"Animal mythique + gelato pistache" },
      { id:'cetu', name:'Mon Bureau', lat:45.73816138599714,  lng:4.924374644771908, radius:20, question:"Qui est mon coll√®gue d'en face ?", answer:"EP", hint:"Animal mythique + gelato pistache" },
      { id:'pantheon', name:'Panth√©on', lat:41.8986, lng:12.4769, radius:20, question:"Comment s'appelle l'ouverture au sommet du d√¥me ?", answer:"oculus", hint:"Mot latin, 6 lettres" }
      // üëâ Ajoute d'autres lieux
    ];

    const ROOMS = [
      { id:'salle1', name:'Salle 1', works:[
        { id:'oeuvre1', title:"Rapha√´l ‚Äì La Transfiguration", question:"Quel d√©tail appara√Æt en haut √† gauche ?", answer:"montagne", hint:"Paysage" },
        { id:'oeuvre2', title:"Michel-Ange ‚Äì Sibylle de Delphes", question:"L'objet qu'elle tient ?", answer:"livre", hint:"Lecture" }
      ]},
      { id:'salle2', name:'Salle 2', works:[
        { id:'oeuvre3', title:"Carte de l'Italie ‚Äì Couloir des cartes", question:"Quel golfe est indiqu√© pr√®s de Naples ?", answer:"golfe de naples", hint:"G√©ographie" }
      ]}
      // üëâ Ajoute tes salles/≈ìuvres
    ];

    // Partie 3 ‚Äî Point A (objectif final) + vid√©o
    const FINALE = { lat:48.88604516592345,   lng:2.2373824246612455, radius:10, youtube:"https://www.youtube.com/watch?v=dQw4w9WgXcQ" };
    // Partie 3 ‚Äî Point B (d√©clencheur d'affichage de la carte P3 √† 1500 m)
    const P3_B = { lat:48.8843621343004,  lng:2.2462767830898454, radius:1500 };

    const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const TILE_ATTRIB = '&copy; contributeurs <a href="https://www.openstreetmap.org/">OpenStreetMap</a>';
    const START_VIEW = [41.8986, 12.4769];
    const START_ZOOM = 15;
    const GEO_OPTIONS = { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 };

    // ========= 2) UTIL ========
    const normalize = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim().toLowerCase();
    const storageKey = (k)=> `rome-game-${k}`;
    const save = (k,v)=> localStorage.setItem(storageKey(k), JSON.stringify(v));
    const load = (k,def)=> { try{ return JSON.parse(localStorage.getItem(storageKey(k))) ?? def; } catch{ return def; } };

    // States persist√©s
    const progress   = load('progress', {});       // Partie 1: { id: 'locked'|'unlocked'|'started'|'done' }
    const p1Override = load('p1Override', false);  // gage ‚Üí 100%
    const p2State    = load('p2State', {});        // Partie 2: { salleId: { oeuvreId: 'done' } }
    const p2Override = load('p2Override', false);
    // Nouvelles persistance des r√©ponses valid√©es
    const p1Answers = load('p1Answers', {});   // { placeId: 'r√©ponse' }
    const p2Answers = load('p2Answers', {});   // { 'roomId.workId': 'r√©ponse' }
    const p3VictoryState = false;

    // ========= 3) PARTIE 1 ‚Äî CARTE ========
    const map = L.map('map');
    L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(map);
    map.setView(START_VIEW, START_ZOOM);

    map.on('popupopen', (e) => {
      const el = e.popup && e.popup.getElement ? e.popup.getElement() : (e.popup && e.popup._container);
      if (el) { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); }
    });

    const IconLocked = new L.DivIcon({ className:'icon-locked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #718096;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîí</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconUnlocked = new L.DivIcon({ className:'icon-unlocked', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #38a169;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">üîì</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });
    const IconDone = new L.DivIcon({ className:'icon-done', html:'<div style="width:26px;height:26px;background:#fff;border:2px solid #2b6cb0;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)">‚úÖ</div>', iconSize:[26,26], iconAnchor:[13,26], popupAnchor:[0,-20] });

    const placesLayer = L.layerGroup().addTo(map);
    let userMarker = null, accuracyCircle = null;

    const placesList = document.getElementById('placesList');

    function renderList(){
      placesList.innerHTML='';
      PLACES.forEach(p=>{
        const st = progress[p.id] || 'locked';
        const div = document.createElement('div');
        div.className = `place-row ${st}`;
        const answerTag = (st==='done' && p1Answers[p.id]) ? `<div class="hint">R√©ponse : <em>${p1Answers[p.id]}</em></div>` : `<div class="hint">rayon ${p.radius} m</div>`;
        div.innerHTML = `<div><strong>${p.name}</strong>${answerTag}</div><div class="right">${st==='done'?'‚úÖ': (st==='unlocked'||st==='started')?'üîì':'üîí'}</div>`;
        div.onclick = ()=> map.setView([p.lat,p.lng], 18, {animate:true});
        placesList.appendChild(div);
      });
      updateP1Progress();
    }

    function placePopupContent(p){
      const st = progress[p.id] || 'locked';
      if(st==='locked'){
        return `<div class="popup"><h3>${p.name}</h3><p>üîí Tu es trop loin. Approche √† <strong>${p.radius} m</strong>.</p></div>`;
      }
      if(st==='done'){
        const ans = p1Answers[p.id] ? `<p><strong>R√©ponse :</strong> ${p1Answers[p.id]}</p>` : '';
        return `<div class="popup"><h3>${p.name}</h3><p>‚úÖ D√©j√† valid√© !</p>${ans}</div>`;
      }
      if(st==='unlocked'){
        return `<div class="popup"><h3>${p.name}</h3><p>Tu es √† port√©e. Pr√™t(e)?</p><button onclick="event.stopPropagation(); window.__startChallenge('${p.id}'); return false;">Commencer le d√©fi</button></div>`;
      }
      // started
      return `<div class="popup"><h3>${p.name}</h3><p>${p.question}</p><input id="ans-${p.id}" type="text" placeholder="R√©ponse" autofocus onclick="event.stopPropagation();" onfocus="event.stopPropagation();" /><button onclick="event.stopPropagation(); window.__checkAnswer('${p.id}'); return false;">Valider</button><p class="hint">Indice : ${p.hint||'‚Äî'}</p></div>`;
    }

    const markersById = {}, lastPopupState = {};

    function addPlaceMarker(p){
      const st = progress[p.id] || 'locked';
      const m = L.marker([p.lat,p.lng], { icon: st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked });
      m.bindPopup(placePopupContent(p));
      m.on('popupopen', ()=> lastPopupState[p.id] = progress[p.id] || 'locked');
      m.addTo(placesLayer);
      markersById[p.id]=m;
    }
    function refreshMarker(p){
      const m = markersById[p.id];
      const st = progress[p.id] || 'locked';
      m.setIcon(st==='done'?IconDone: (st==='unlocked'||st==='started')?IconUnlocked:IconLocked);
      m.setPopupContent(placePopupContent(p));
    }

    PLACES.forEach(addPlaceMarker);
    function renderMarkers(){ PLACES.forEach(refreshMarker); }

    window.__startChallenge = function(id){
      const p=PLACES.find(x=>x.id===id); if(!p) return;
      progress[id]='started'; save('progress',progress);
      refreshMarker(p); markersById[id].openPopup(); lastPopupState[id]='started';
      updateP1Progress();
    };

    window.__checkAnswer = function(id){
      const p=PLACES.find(x=>x.id===id); const input=document.getElementById(`ans-${id}`);
      if(!p||!input) return;
      const userVal = input.value;
      const ok = normalize(userVal)===normalize(p.answer);
      const gpsText=document.getElementById('gpsText');
      if(ok){
        progress[id]='done';
        p1Answers[id] = userVal; // conserve la r√©ponse telle que saisie
        save('progress',progress); save('p1Answers', p1Answers);
        refreshMarker(p); renderList();
        gpsText.textContent=`Bravo ! √âtape ¬´ ${p.name} ¬ª valid√©e.`; lastPopupState[id]='done';
      } else {
        gpsText.textContent='Mauvaise r√©ponse, essaie encore.'; input.focus(); input.select&&input.select();
      }
    };

    function updateP1Progress(){
      const total = PLACES.length;
      const done  = PLACES.filter(p=>progress[p.id]==='done').length;
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p1Override', false);
      if(override) pct=100;
      document.getElementById('p1Pct').textContent = pct+'%';
      document.getElementById('p1Bar').style.width = pct+'%';
      const key = document.getElementById('p1Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 4) PARTIE 2 ‚Äî ROOMS ========
    const roomsContainer = document.getElementById('rooms');
    function renderRooms(){
      roomsContainer.innerHTML='';
      ROOMS.forEach(room=>{
        const card=document.createElement('div'); card.className='room';
        card.innerHTML = `<h3>${room.name}</h3>`;
        const list=document.createElement('div');
        const state = p2State[room.id] || {};
        room.works.forEach(w=>{
          const done = state[w.id]==='done';
          const key = `${room.id}.${w.id}`;
          const savedVal = p2Answers[key] || '';
          const row=document.createElement('div'); row.className='work';
          row.innerHTML = `<div class=\"state\">${done?'‚úÖ':'üïµÔ∏è'}</div>
            <div class=\"title\" style=\"flex:1\"><strong>${w.title}</strong><div class=\"hint\">${w.question}</div></div>
            <input type=\"text\" id=\"w-${room.id}-${w.id}\" placeholder=\"R√©ponse\" ${done?'disabled':''} value=\"${done ? savedVal.replace(/\"/g,'\\"') : ''}\"/>
            <button data-room=\"${room.id}\" data-work=\"${w.id}\">${done?'R√©pondu':'Valider'}</button>`;
          list.appendChild(row);
        });
        card.appendChild(list);
        roomsContainer.appendChild(card);
      });
      roomsContainer.querySelectorAll('button[data-room]').forEach(btn=>{
        btn.onclick=()=>{
          const roomId=btn.getAttribute('data-room'); const workId=btn.getAttribute('data-work');
          const room=ROOMS.find(r=>r.id===roomId); const work=room.works.find(x=>x.id===workId);
          const input=document.getElementById(`w-${roomId}-${workId}`); if(!input) return;
          const ok=normalize(input.value)===normalize(work.answer);
          if(ok){
            // conserve la valeur telle que saisie
            const key = `${roomId}.${workId}`;
            p2State[roomId]=p2State[roomId]||{}; p2State[roomId][workId]='done';
            p2Answers[key] = input.value;
            save('p2State',p2State); save('p2Answers', p2Answers);
            renderRooms(); updateP2Progress();
          }else{ input.focus(); input.select&&input.select(); }
        };
      });
    }

    function updateP2Progress(){
      const total = ROOMS.reduce((s,r)=>s+r.works.length,0);
      const done  = ROOMS.reduce((s,r)=> s + (Object.values(p2State[r.id]||{}).filter(v=>v==='done').length), 0);
      let pct = Math.round((done/Math.max(1,total))*100);
      const override = load('p2Override', false);
      if(override) pct=100;
      document.getElementById('p2Pct').textContent = pct+'%';
      document.getElementById('p2Bar').style.width = pct+'%';
      const key = document.getElementById('p2Key');
      if(pct>=100){ key.removeAttribute('disabled'); }
      else { key.setAttribute('disabled',''); key.removeAttribute('open'); }
      updateP3FromKeys(); updatePart2Lock();
    }

    // ========= 5) PARTIE 3 ‚Äî CL√âS + GEOFENCE + CARTE POINT B & CHAUD/FROID ========
    const p3Status=document.getElementById('p3Status');
    const p3Action=document.getElementById('p3Action');
    const p3Pct=document.getElementById('p3Pct');
    const p3Bar=document.getElementById('p3Bar');
    const victoryLink=document.getElementById('victoryLink'); victoryLink.href = FINALE.youtube;

    // Carte de la Partie 3
    const p3MapWrap = document.getElementById('p3MapWrap');
    let p3Map=null, p3UserMarker=null, p3BCircle=null, p3ACircle=null, p3AMarker=null;

    // D√©grad√© couleur du marqueur utilisateur selon distance au Point A
    function lerp(a,b,t){ return a + (b-a)*t; }
    function heatColor(distance){
      // 0 m ‚Üí rouge, ‚â•1500 m ‚Üí bleu
      const max=1500; const t = 1 - Math.min(distance, max)/max;
      const r = Math.round(lerp(30, 220, t));   // bleu(30,58,138) ‚Üí rouge(220,38,38)
      const g = Math.round(lerp(58, 38, t));
      const b = Math.round(lerp(138, 38, t));
      return `rgb(${r},${g},${b})`;
    }
    function userDivIcon(color){
      return new L.DivIcon({
        className:'p3-user',
        html:`<div style="width:22px;height:22px;border:2px solid #fff;background:${color};border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.25)"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
    }

    function updateP3FromKeys(){
      const k1=!document.getElementById('p1Key').hasAttribute('disabled');
      const k2=!document.getElementById('p2Key').hasAttribute('disabled');
      const pct=(k1?50:0)+(k2?50:0);
      p3Pct.textContent=pct+'%'; p3Bar.style.width=pct+'%';
      if(k1&&k2){ p3Status.textContent='‚úÖ Cl√©s r√©unies ! Va au point final (10 m).'; p3Action.style.display='block'; }
      else { p3Status.innerHTML='üîí En attente : il faut d√©bloquer <strong>Cl√© 1</strong> et <strong>Cl√© 2</strong>.'; p3Action.style.display='none'; }
    }

    // ========= 6) G√âOLOCALISATION COMMUNE ========
    const gpsDot=document.getElementById('gpsDot');
    const gpsText=document.getElementById('gpsText');
    const accText=document.getElementById('accText');
    let watchId=null;
    function setStatus(kind,text,acc){ gpsDot.className='dot '+(kind||'err'); gpsText.textContent=text||''; accText.textContent=acc?`¬± ${Math.round(acc)} m`:'‚Äî'; }
    function ensureLocate(){ if(!('geolocation' in navigator)){ setStatus('err','G√©olocalisation non support√©e'); return; } if(watchId!==null) return; setStatus('warn','Demande de GPS‚Ä¶'); watchId=navigator.geolocation.watchPosition(onPos,onGeoError,GEO_OPTIONS); }
    function onGeoError(err){ setStatus('err',err.message||'Erreur de g√©olocalisation'); }

    const finaleCircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#2b6cb0', weight:1, fillOpacity:0.05 });

    function onPos(pos){
      const { latitude, longitude, accuracy } = pos.coords; const here=[latitude,longitude];
      // Marqueur utilisateur (Partie 1)
      if(!userMarker){ userMarker=L.marker(here,{title:'Vous'}).addTo(map); } else { userMarker.setLatLng(here); }
      if(!accuracyCircle){ accuracyCircle=L.circle(here,{radius:accuracy,weight:1,fillOpacity:0.1}).addTo(map); } else { accuracyCircle.setLatLng(here).setRadius(accuracy); }
      setStatus('ok','GPS actif',accuracy);

      // D√©verrouillage P1
      PLACES.forEach(p=>{
        const prev=progress[p.id]||'locked';
        const d=map.distance(here,[p.lat,p.lng]); const r=p.radius||20;
        if(d<=r && prev==='locked'){
          progress[p.id]='unlocked'; save('progress',progress);
          refreshMarker(p); renderList(); markersById[p.id].openPopup(); lastPopupState[p.id]='unlocked';
        }
        const curr=progress[p.id]||'locked'; const m=markersById[p.id];
        if(m.isPopupOpen()){
          if(curr==='locked'){
            m.setPopupContent(`<div class="popup"><h3>${p.name}</h3><p>üîí Tu es √† <strong>${Math.round(d)} m</strong>. Approche √† moins de <strong>${r} m</strong>.</p></div>`);
            lastPopupState[p.id]='locked';
          } else if(lastPopupState[p.id]!==curr){ m.setPopupContent(placePopupContent(p)); lastPopupState[p.id]=curr; }
        }
      });

      // Partie 3 : Carte conditionnelle autour de B + couleur ‚Äúchaud/froid‚Äù vers A
      const keysOK = !document.getElementById('p1Key').hasAttribute('disabled') && !document.getElementById('p2Key').hasAttribute('disabled');
      if(keysOK){
        const dB = map.distance(here, [P3_B.lat, P3_B.lng]);
        if(dB <= (P3_B.radius||1500)){
          // Afficher/initialiser carte P3
          p3MapWrap.style.display='block';
          if(!p3Map){
            p3Map = L.map('mapP3');
            L.tileLayer(TILE_URL, { attribution: TILE_ATTRIB, maxZoom: 19 }).addTo(p3Map);
            p3Map.setView([P3_B.lat, P3_B.lng], 15);
            p3BCircle = L.circle([P3_B.lat, P3_B.lng], { radius: P3_B.radius, color:'#2b6cb0', weight:1, fillOpacity:0.03 }).addTo(p3Map);
            // p3ACircle : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
            // p3AMarker : rendu uniquement quand le joueur est √† ‚â§ 10m du Point A
          }
          // Mettre √† jour marqueur utilisateur P3 + couleur
          const dA = map.distance(here, [FINALE.lat, FINALE.lng]);
          const color = heatColor(dA);
          if(!p3UserMarker){ p3UserMarker = L.marker(here, { icon: userDivIcon(color) }).addTo(p3Map); }
          else { p3UserMarker.setLatLng(here); p3UserMarker.setIcon(userDivIcon(color)); }
          // Afficher/masquer le Point A uniquement dans un rayon de 10 m
          if(dA <= (FINALE.radius||10)){
            if(!p3AMarker){ p3AMarker = L.marker([FINALE.lat, FINALE.lng], { title:'Point A (objectif)' }).addTo(p3Map); }
            if(!p3ACircle){ p3ACircle = L.circle([FINALE.lat, FINALE.lng], { radius: FINALE.radius, color:'#dc2626', weight:1, fillOpacity:0.06 }).addTo(p3Map); }
          } else {
            if(p3AMarker){ p3Map.removeLayer(p3AMarker); p3AMarker = null; }
            if(p3ACircle){ p3Map.removeLayer(p3ACircle); p3ACircle = null; }
          }
          // Victoire √† 10 m
          if(dA <= (FINALE.radius||10)){
            p3Status.textContent='üéØ Point final atteint !';
            const v = document.getElementById('p3Victory');
            if(v){ v.removeAttribute('disabled'); v.setAttribute('open',''); }
            p3Action.style.display='none';
          } else {
            const v = document.getElementById('p3Victory');
            if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); }
          }
        } else {
          // Hors zone de B ‚Üí cacher la carte P3
          p3MapWrap.style.display='none';
        }
      }
    }

    // ========= 7) NAV + BOUTONS ========
    document.getElementById('btnLocate').addEventListener('click', ()=>{ ensureLocate(); if(userMarker) map.setView(userMarker.getLatLng(), 17, {animate:true}); });
    document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('R√©initialiser toute la progression ?')) return; localStorage.clear(); location.reload(); });

    document.getElementById('p1GageDone').addEventListener('click', ()=>{ save('p1Override', true); updateP1Progress(); alert('Partie 1 valid√©e √† 100%'); });
    document.getElementById('p2GageDone').addEventListener('click', ()=>{ save('p2Override', true); updateP2Progress(); alert('Partie 2 valid√©e √† 100%'); });

    const drawerBtn=document.getElementById('btnDrawer');
    const navButtons=[...document.querySelectorAll('#drawer .nav-item')];
    drawerBtn.addEventListener('click', ()=>{ const d=document.getElementById('drawer'); d.style.display=(d.style.display==='none'?'block':'none'); });
    navButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const target=btn.getAttribute('data-target');
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible'));
      document.getElementById(target).classList.add('visible');
      if(target==='part1'){ setTimeout(()=> map.invalidateSize(), 50); }
      if(target==='part3' && p3Map){ setTimeout(()=> p3Map.invalidateSize(), 50); }
    }));

    // ====== Contr√¥le d'acc√®s √† la Partie 2 (verrou si Partie 1 < 100%) ======
    const btnPart2 = document.querySelector('#drawer .nav-item[data-target="part2"]');
    function updatePart2Lock(){
      const allowed = !document.getElementById('p1Key').hasAttribute('disabled');
      if(allowed){
        btnPart2 && btnPart2.removeAttribute('disabled');
        if(btnPart2) btnPart2.title = 'üñºÔ∏è Partie 2 ‚Äî Vatican';
      } else {
        btnPart2 && btnPart2.setAttribute('disabled','');
        if(btnPart2) btnPart2.title = 'üîí Termine d\'abord la Partie 1 (100%)';
        // Si on est d√©j√† sur la Partie 2, on renvoie vers la Partie 1
        if(document.getElementById('part2').classList.contains('visible')){
          const btnP1 = document.querySelector('#drawer .nav-item[data-target="part1"]');
          btnP1 && btnP1.click();
        }
      }
    }
    // Bloque les clics sur le bouton Part 2 quand il est d√©sactiv√© (s√©curit√© suppl√©mentaire)
    document.addEventListener('click', (e)=>{
      const t = e.target.closest && e.target.closest('#drawer .nav-item[data-target="part2"]');
      if(t && t.hasAttribute('disabled')){ e.preventDefault(); e.stopPropagation(); alert('üîí Termine d\'abord la Partie 1 (100%) pour acc√©der √† la Partie 2.'); }
    });

    // ========= 8) RENDER INIT ========
    PLACES.forEach(addPlaceMarker); renderList();
    renderRooms(); updateP2Progress();
    updateP1Progress(); updateP3FromKeys(); updatePart2Lock();
    // Si la victoire a d√©j√† √©t√© atteinte dans une session pr√©c√©dente, d√©bloquer le dossier
    { const v=document.getElementById('p3Victory'); if(v){ v.setAttribute('disabled',''); v.removeAttribute('open'); } } 
    // iOS : demander d'appuyer sur üìç pour activer la g√©oloc
  </script>
</body>
</html>
